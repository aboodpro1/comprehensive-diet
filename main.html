<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دليل العناصر الغذائية الأساسية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: auto;
            max-height: 400px;
        }
        .nutrient-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .nutrient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .details-panel {
            display: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .details-panel.active {
            display: block;
            max-height: 1000px;
        }
        .tab-button {
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-button.active {
            background-color: #10B981;
            color: white;
            border-color: #10B981;
        }
        .food-item-btn {
            transition: transform 0.1s;
        }
        .food-item-btn:active {
            transform: scale(0.95);
        }
        .food-image {
            width: 48px;
            height: 48px;
            border-radius: 9999px;
            object-fit: cover;
            object-position: center;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .quantity-control button {
            width: 2rem;
            height: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.1s;
        }
        .quantity-control button:hover {
            background-color: #d1d5db;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10B981;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-emerald-600">دليلك الشامل للعناصر الغذائية</h1>
            <p class="mt-4 text-lg text-gray-600">اكتشف اللبنات الأساسية لصحة جسمك وكيفية الحصول عليها.</p>
        </header>

        <nav class="flex justify-center mb-12 border-b border-gray-200 pb-4">
            <button id="macro-tab" class="tab-button active text-lg font-semibold py-3 px-6 rounded-t-lg border-b-2 border-transparent" onclick="showSection('macro')">العناصر الغذائية الكبرى</button>
            <button id="micro-tab" class="tab-button text-lg font-semibold py-3 px-6 rounded-t-lg border-b-2 border-transparent" onclick="showSection('micro')">العناصر الغذائية الصغرى</button>
        </nav>

        <main id="main-content">
            <section id="macro-section">
                <div class="text-center mb-12">
                     <h2 class="text-3xl font-bold text-gray-800">ما هي العناصر الغذائية الكبرى؟</h2>
                     <p class="mt-3 max-w-3xl mx-auto text-gray-600">هي العناصر التي يحتاجها الجسم بكميات كبيرة لتوفير الطاقة والنمو وإصلاح الأنسجة. تشمل الكربوهيدرات، البروتينات، والدهون. يوضح الرسم البياني أدناه التوزيع المثالي للسعرات الحرارية اليومية من هذه العناصر.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-center mb-12">
                    <div class="lg:col-span-2">
                         <div class="chart-container">
                            <canvas id="macroChart"></canvas>
                        </div>
                    </div>
                     <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="nutrient-card bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-400" onclick="toggleDetails('carb-details')">
                            <h3 class="text-xl font-bold text-blue-500">الكربوهيدرات</h3>
                            <p class="mt-2 text-gray-600">مصدر الطاقة الرئيسي للجسم والدماغ.</p>
                        </div>
                        <div class="nutrient-card bg-white p-6 rounded-xl shadow-md border-t-4 border-red-400" onclick="toggleDetails('protein-details')">
                            <h3 class="text-xl font-bold text-red-500">البروتينات</h3>
                            <p class="mt-2 text-gray-600">أساسية لبناء وإصلاح العضلات والأنسجة.</p>
                        </div>
                        <div class="nutrient-card bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-400" onclick="toggleDetails('fat-details')">
                             <h3 class="text-xl font-bold text-yellow-500">الدهون</h3>
                             <p class="mt-2 text-gray-600">تدعم الهرمونات وامتصاص الفيتامينات.</p>
                        </div>
                    </div>
                </div>

                <div id="carb-details" class="details-panel mt-8 bg-blue-50 p-6 rounded-lg border border-blue-200">
                    <h4 class="text-2xl font-bold text-blue-600">تفاصيل الكربوهيدرات</h4>
                    <p class="mt-2"><strong>الوظيفة:</strong> هي الوقود المفضل للجسم، وخاصة للدماغ والجهاز العصبي المركزي أثناء ممارسة الرياضة. تنقسم إلى بسيطة ومعقدة.</p>
                    <p class="mt-2"><strong>المصادر الصحية:</strong> الحبوب الكاملة (الشوفان، الأرز البني)، الفواكه، الخضروات النشوية (البطاطا، الذرة)، والبقوليات (العدس، الحمص).</p>
                </div>
                 <div id="protein-details" class="details-panel mt-8 bg-red-50 p-6 rounded-lg border border-red-200">
                    <h4 class="text-2xl font-bold text-red-600">تفاصيل البروتينات</h4>
                    <p class="mt-2"><strong>الوظيفة:</strong> تتكون من أحماض أمينية، وهي ضرورية لنمو الخلايا، وظيفة المناعة، وإنتاج الإنزيمات والهرمونات.</p>
                    <p class="mt-2"><strong>المصادر:</strong> اللحوم الخالية من الدهون، الدواجن، الأسماك، البيض، منتجات الألبان، البقوليات، المكسرات، وبذور الكينوا.</p>
                </div>
                <div id="fat-details" class="details-panel mt-8 bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                    <h4 class="text-2xl font-bold text-yellow-600">تفاصيل الدهون</h4>
                    <p class="mt-2"><strong>الوظيفة:</strong> مصدر طاقة مركز، تساعد في حماية الأعضاء، وتدعم امتصاص الفيتامينات الذائبة في الدهون (A, D, E, K).</p>
                    <p class="mt-2"><strong>المصادر الصحية:</strong> الأفوكادو، زيت الزيتون، المكسرات (اللوز، الجوز)، البذور (الشيا، الكتان)، والأسماك الدهنية (السلمون).</p>
                </div>
                
                <div class="mt-12 bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-400">
                    <h2 class="text-2xl font-bold mb-4 text-center text-emerald-600">حاسبة احتياجاتك اليومية</h2>
                    <p class="text-center text-gray-600 mb-6">أدخل عمرك ووزنك وجنسك لتقدير احتياجاتك اليومية من العناصر الغذائية.</p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                        <div class="w-full sm:w-1/3">
                            <label for="age-input" class="block text-gray-700 font-semibold mb-2">العمر (سنوات)</label>
                            <input type="number" id="age-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" placeholder="مثال: 30" min="1" max="100">
                        </div>
                        <div class="w-full sm:w-1/3">
                            <label for="weight-input" class="block text-gray-700 font-semibold mb-2">الوزن (كجم)</label>
                            <input type="number" id="weight-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" placeholder="مثال: 70" min="1" max="500">
                        </div>
                        <div class="w-full sm:w-1/3">
                            <label for="gender-select" class="block text-gray-700 font-semibold mb-2">الجنس</label>
                            <select id="gender-select" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300">
                                <option value="male">ذكر</option>
                                <option value="female">أنثى</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button onclick="calculateNeeds()" class="bg-emerald-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-emerald-600 transition">احسب احتياجاتي</button>
                    </div>
                    <div id="results-panel" class="mt-8 p-6 bg-slate-100 rounded-lg shadow-inner hidden">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">الاحتياجات اليومية المقدرة:</h4>
                        <p class="text-sm text-gray-600 mb-4">ملاحظة: تحتاج إلى فيتامين د لضمان امتصاص جسمك للكالسيوم بشكل صحيح.</p>
                        <ul class="space-y-3">
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-gray-700">السعرات الحرارية:</span> <span id="calories-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-blue-500">الكربوهيدرات:</span> <span id="carb-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-red-500">البروتينات:</span> <span id="protein-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-yellow-500">الدهون:</span> <span id="fat-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-purple-500">الكالسيوم:</span> <span id="calcium-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-orange-500">فيتامين د:</span> <span id="vitamin-d-result" class="font-semibold text-gray-800"></span></li>
                        </ul>
                        <div id="analysis-panel" class="mt-6 pt-4 border-t border-gray-300">
                             <h4 class="text-xl font-bold text-gray-800 mb-3">تحليل احتياجاتك:</h4>
                             <p id="analysis-text" class="text-gray-700"></p>
                        </div>
                    </div>

                    <div id="custom-plan-builder" class="mt-12 bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-400 hidden">
                        <h2 class="text-2xl font-bold mb-4 text-center text-emerald-600">اصنع نظامك الغذائي الخاص</h2>
                        <p class="text-center text-gray-600 mb-6">اختر من الأطعمة أدناه لإضافتها إلى خطتك الغذائية اليومية.</p>
                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">قائمة الأطعمة</h3>
                                <div id="food-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 p-4 border border-gray-200 rounded-lg max-h-80 overflow-y-auto">
                                    <!-- Food items will be dynamically generated here -->
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">خطتي الغذائية</h3>
                                <div class="bg-slate-100 rounded-lg p-4 shadow-inner min-h-[10rem] max-h-80 overflow-y-auto">
                                    <ul id="my-plan-list" class="space-y-3">
                                        <!-- Selected food items will be listed here -->
                                    </ul>
                                </div>
                                <div class="mt-4 p-4 bg-emerald-100 rounded-lg border-t-4 border-emerald-400">
                                     <h4 class="font-bold text-lg text-emerald-700 mb-2">الإجمالي:</h4>
                                     <ul class="text-gray-700 space-y-1">
                                         <li class="flex justify-between"><span>السعرات الحرارية:</span> <span id="total-calories" class="font-semibold">0</span></li>
                                         <li class="flex justify-between"><span>البروتينات:</span> <span id="total-protein" class="font-semibold">0 جرام</span></li>
                                         <li class="flex justify-between"><span>الكربوهيدرات:</span> <span id="total-carbs" class="font-semibold">0 جرام</span></li>
                                         <li class="flex justify-between"><span>الدهون:</span> <span id="total-fats" class="font-semibold">0 جرام</span></li>
                                         <li class="flex justify-between"><span>الكالسيوم:</span> <span id="total-calcium" class="font-semibold">0 ملجم</span></li>
                                     </ul>
                                </div>
                                <div class="mt-4 flex flex-col gap-2">
                                     <button id="generate-plan-btn" onclick="generateMealPlan()" class="bg-purple-500 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-purple-600 transition flex items-center justify-center">
                                         <span class="mr-2">✨</span>
                                         <span>توليد خطة غذائية</span>
                                         <div id="plan-loader" class="loader ml-2 hidden"></div>
                                     </button>
                                     <button id="generate-recipes-btn" onclick="generateRecipes()" class="bg-cyan-500 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-cyan-600 transition flex items-center justify-center">
                                         <span class="mr-2">✨</span>
                                         <span>توليد وصفات</span>
                                         <div id="recipes-loader" class="loader ml-2 hidden"></div>
                                     </button>
                                </div>
                            </div>
                        </div>
                         <div id="ai-output" class="mt-8 p-6 bg-slate-100 rounded-lg shadow-inner hidden">
                            <h4 class="text-xl font-bold text-gray-800 mb-3" id="ai-output-title"></h4>
                            <div id="ai-output-content" class="text-gray-700 space-y-4"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="micro-section" style="display: none;">
                <div class="text-center mb-12">
                     <h2 class="text-3xl font-bold text-gray-800">ما هي العناصر الغذائية الصغرى؟</h2>
                     <p class="mt-3 max-w-3xl mx-auto text-gray-600">هي الفيتامينات والمعادن التي يحتاجها الجسم بكميات أقل، ولكنها حيوية للغاية للوظائف الفسيولوجية الطبيعية، من دعم المناعة إلى صحة العظام. انقر على كل فئة لاستكشافها.</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div id="vitamins-container" class="bg-white p-6 rounded-xl shadow-lg">
                         <h3 class="text-2xl font-bold mb-4 text-center text-emerald-600">الفيتامينات</h3>
                         <div class="space-y-3" id="vitamins-list"></div>
                    </div>
                    <div id="minerals-container" class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-2xl font-bold mb-4 text-center text-emerald-600">المعادن</h3>
                        <div class="space-y-3" id="minerals-list"></div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-16 pt-8 border-t border-gray-200">
            <p class="text-gray-500">تم تصميم هذا الدليل لتوفير معلومات عامة. استشر دائمًا أخصائي تغذية أو طبيبًا للحصول على نصائح شخصية.</p>
        </footer>
    </div>

<script>
    const macroChartCtx = document.getElementById('macroChart').getContext('2d');
    const macroChart = new Chart(macroChartCtx, {
        type: 'doughnut',
        data: {
            labels: ['الكربوهيدرات', 'البروتينات', 'الدهون'],
            datasets: [{
                label: 'توزيع السعرات الحرارية',
                data: [50, 20, 30],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(248, 113, 113, 0.7)',
                    'rgba(251, 191, 36, 0.7)'
                ],
                borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(248, 113, 113, 1)',
                    'rgba(251, 191, 36, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            family: 'Cairo',
                            size: 14
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += context.parsed + '% من السعرات اليومية';
                            }
                            return label;
                        }
                    },
                    bodyFont: {
                        family: 'Cairo'
                    },
                    titleFont: {
                        family: 'Cairo'
                    }
                }
            }
        }
    });

    let activeDetailsPanel = null;
    
    function toggleDetails(panelId) {
        const panel = document.getElementById(panelId);
        
        if(activeDetailsPanel && activeDetailsPanel !== panel) {
            activeDetailsPanel.classList.remove('active');
        }

        panel.classList.toggle('active');

        if (panel.classList.contains('active')) {
            activeDetailsPanel = panel;
        } else {
            activeDetailsPanel = null;
        }
    }

    function showSection(section) {
        const macroSection = document.getElementById('macro-section');
        const microSection = document.getElementById('micro-section');
        const macroTab = document.getElementById('macro-tab');
        const microTab = document.getElementById('micro-tab');

        if (section === 'macro') {
            macroSection.style.display = 'block';
            microSection.style.display = 'none';
            macroTab.classList.add('active');
            microTab.classList.remove('active');
        } else {
            macroSection.style.display = 'none';
            microSection.style.display = 'block';
            macroTab.classList.remove('active');
            microTab.classList.add('active');
        }
    }
    
    const micronutrients = {
        vitamins: [
            { name: "فيتامين أ", description: "ضروري للرؤية، وظيفة المناعة، وصحة الجلد.", sources: "الجزر، البطاطا الحلوة، السبانخ." },
            { name: "فيتامين د", description: "يساعد على امتصاص الكالسيوم لصحة العظام.", sources: "أشعة الشمس، الأسماك الدهنية، الحليب المدعم." },
            { name: "فيتامين هـ", description: "مضاد للأكسدة يحمي الخلايا من التلف.", sources: "المكسرات، البذور، زيت عباد الشمس." },
            { name: "فيتامين ك", description: "مهم لتخثر الدم وصحة العظام.", sources: "الخضروات الورقية الخضراء (الكرنب، السبانخ)." },
            { name: "فيتامين ج", description: "يعزز جهاز المناعة ويساعد في إنتاج الكولاجين.", sources: "الحمضيات (البرتقال)، الفراولة، الفلفل." },
            { name: "فيتامينات ب", description: "مجموعة فيتامينات تساعد في استقلاب الطاقة ووظائف الدماغ.", sources: "الحبوب الكاملة، اللحوم، البيض، البقوليات." }
        ],
        minerals: [
            { name: "الكالسيوم", description: "أساسي لبناء عظام وأسنان قوية.", sources: "منتجات الألبان، البروكلي، اللوز." },
            { name: "الحديد", description: "ينقل الأكسجين في الدم ويمنع فقر الدم.", sources: "اللحوم الحمراء، السبانخ، العدس." },
            { name: "البوتاسيوم", description: "ينظم توازن السوائل وضغط الدم.", sources: "الموز، البطاطا، الأفوكادو." },
            { name: "المغنيسيوم", description: "يشارك في أكثر من 300 تفاعل إنزيمي في الجسم.", sources: "المكسرات، البذور، الشوكولاتة الداكنة." },
            { name: "الزنك", description: "يدعم وظيفة المناعة والتئام الجروح.", sources: "اللحوم، المحار، بذور اليقطين." },
            { name: "اليود", description: "ضروري لوظيفة الغدة الدرقية الصحية.", sources: "ملح الطعام المدعم باليود، الأعشاب البحرية، الأسماك." }
        ]
    };

    function createMicroNutrientList(data, containerId) {
        const container = document.getElementById(containerId);
        data.forEach((item, index) => {
            const wrapper = document.createElement('div');
            const button = document.createElement('button');
            button.className = 'w-full text-right p-3 bg-gray-100 rounded-lg font-semibold hover:bg-emerald-100 transition flex justify-between items-center';
            button.innerHTML = `<span>${item.name}</span> <span class="plus-icon text-emerald-500 font-bold text-xl">+</span>`;
            
            const details = document.createElement('div');
            details.className = 'details-panel p-4 bg-white border-l-4 border-emerald-200';
            details.innerHTML = `
                <p><strong>الوظيفة:</strong> ${item.description}</p>
                <p class="mt-2"><strong>أبرز المصادر:</strong> ${item.sources}</p>
            `;

            button.onclick = () => {
                const isActive = details.classList.contains('active');
                
                document.querySelectorAll(`#${containerId} .details-panel`).forEach(p => p.classList.remove('active'));
                document.querySelectorAll(`#${containerId} .plus-icon`).forEach(icon => icon.textContent = '+');

                if (!isActive) {
                    details.classList.add('active');
                    button.querySelector('.plus-icon').textContent = '-';
                }
            };
            
            wrapper.appendChild(button);
            wrapper.appendChild(details);
            container.appendChild(wrapper);
        });
    }

    createMicroNutrientList(micronutrients.vitamins, 'vitamins-list');
    createMicroNutrientList(micronutrients.minerals, 'minerals-list');
    
    // Food data with image prompts
    const foodDatabase = [
        { name: 'صدر دجاج (100ج)', calories: 165, protein: 31, carbs: 0, fats: 3.6, calcium: 10, imagePrompt: 'a grilled chicken breast' },
        { name: 'بيض مسلوق (1 بيضة كبيرة)', calories: 78, protein: 6.3, carbs: 0.6, fats: 5.3, calcium: 25, imagePrompt: 'a perfectly boiled egg' },
        { name: 'أرز أبيض مطبوخ (100ج)', calories: 130, protein: 2.7, carbs: 28, fats: 0.3, calcium: 15, imagePrompt: 'a bowl of cooked white rice' },
        { name: 'خبز قمح كامل (شريحة)', calories: 82, protein: 4, carbs: 14.8, fats: 1.1, calcium: 30, imagePrompt: 'a slice of whole wheat bread' },
        { name: 'عدس مطبوخ (100ج)', calories: 116, protein: 9, carbs: 20, fats: 0.4, calcium: 19, imagePrompt: 'a bowl of cooked lentils' },
        { name: 'سبانخ (100ج)', calories: 23, protein: 2.9, carbs: 3.6, fats: 0.4, calcium: 99, imagePrompt: 'fresh spinach leaves' },
        { name: 'تفاح (100ج)', calories: 52, protein: 0.3, carbs: 13.8, fats: 0.2, calcium: 6, imagePrompt: 'a red apple' },
        { name: 'بروكلي (100ج)', calories: 34, protein: 2.8, carbs: 6.6, fats: 0.4, calcium: 47, imagePrompt: 'a head of broccoli' },
        { name: 'أفوكادو (100ج)', calories: 160, protein: 2, carbs: 8.5, fats: 14.7, calcium: 12, imagePrompt: 'a sliced avocado' },
        { name: 'زيت زيتون (ملعقة كبيرة)', calories: 119, protein: 0, carbs: 0, fats: 13.5, calcium: 0, imagePrompt: 'a bottle of olive oil' },
        { name: 'لوز (100ج)', calories: 579, protein: 21, carbs: 21.5, fats: 49.9, calcium: 264, imagePrompt: 'a handful of almonds' },
        { name: 'زبادي يوناني (100ج)', calories: 59, protein: 10, carbs: 3.6, fats: 0.4, calcium: 101, imagePrompt: 'a bowl of greek yogurt' },
        { name: 'قهوة سادة (240 مل)', calories: 2, protein: 0.3, carbs: 0, fats: 0, calcium: 5, imagePrompt: 'a cup of black coffee' },
        { name: 'لبن بقري (150ج)', calories: 90, protein: 5.3, carbs: 7.1, fats: 5.0, calcium: 180, imagePrompt: 'a bowl of cow milk yogurt' },
        { name: 'حليب بقري (240 مل)', calories: 149, protein: 8, carbs: 12, fats: 8, calcium: 300, imagePrompt: 'a glass of cow milk' }
    ];

    let myPlan = [];

    function renderFoodList() {
        const foodListContainer = document.getElementById('food-list');
        foodListContainer.innerHTML = '';
        foodDatabase.forEach(food => {
            const button = document.createElement('button');
            button.className = 'food-item-btn flex flex-col items-center justify-center p-4 bg-gray-100 rounded-xl shadow hover:bg-emerald-100 transition-colors cursor-pointer';
            
            button.innerHTML = `
                <img src="https://placehold.co/48x48/d1d5db/4b5563?text=food" class="food-image mb-2" alt="صورة ${food.name}">
                <span class="text-sm font-semibold text-gray-800 text-center">${food.name}</span>
                <span class="text-xs text-gray-500 mt-1">${food.calories} سعر حراري</span>
            `;
            button.onclick = () => addFoodToPlan(food);
            foodListContainer.appendChild(button);
        });
    }

    function addFoodToPlan(food) {
        const existingFood = myPlan.find(item => item.name === food.name);
        if (existingFood) {
            existingFood.quantity++;
        } else {
            myPlan.push({ ...food, quantity: 1 });
        }
        updatePlanDisplay();
    }
    
    function updatePlanDisplay() {
        const myPlanList = document.getElementById('my-plan-list');
        myPlanList.innerHTML = '';
        
        let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFats = 0, totalCalcium = 0;

        myPlan.forEach((item, index) => {
            totalCalories += (item.calories || 0) * item.quantity;
            totalProtein += (item.protein || 0) * item.quantity;
            totalCarbs += (item.carbs || 0) * item.quantity;
            totalFats += (item.fats || 0) * item.quantity;
            totalCalcium += (item.calcium || 0) * item.quantity;

            const listItem = document.createElement('li');
            listItem.className = 'flex justify-between items-center bg-white p-3 rounded-lg shadow-sm text-sm';
            listItem.innerHTML = `
                <div>
                    <span class="font-bold text-gray-700">${item.name}</span>
                    <span class="text-xs text-gray-500 block">
                        (${item.calories} س، ${item.protein}ب، ${item.carbs}ك، ${item.fats}د)
                    </span>
                </div>
                <div class="quantity-control">
                    <button onclick="changeQuantity(${index}, -1)" class="text-gray-600 font-bold">-</button>
                    <span class="px-2 text-gray-800">${item.quantity}</span>
                    <button onclick="changeQuantity(${index}, 1)" class="text-gray-600 font-bold">+</button>
                </div>
            `;
            myPlanList.appendChild(listItem);
        });

        document.getElementById('total-calories').textContent = totalCalories.toFixed(0);
        document.getElementById('total-protein').textContent = `${totalProtein.toFixed(1)} جرام`;
        document.getElementById('total-carbs').textContent = `${totalCarbs.toFixed(1)} جرام`;
        document.getElementById('total-fats').textContent = `${totalFats.toFixed(1)} جرام`;
        document.getElementById('total-calcium').textContent = `${totalCalcium.toFixed(0)} ملجم`;
    }

    function changeQuantity(index, change) {
        if (myPlan[index].quantity + change > 0) {
            myPlan[index].quantity += change;
        } else {
            myPlan.splice(index, 1);
        }
        updatePlanDisplay();
    }

    function calculateNeeds() {
        const age = parseInt(document.getElementById('age-input').value);
        const weight = parseInt(document.getElementById('weight-input').value);
        const gender = document.getElementById('gender-select').value;
        const resultsPanel = document.getElementById('results-panel');
        const customPlanBuilder = document.getElementById('custom-plan-builder');
        
        if (isNaN(age) || isNaN(weight) || age <= 0 || weight <= 0) {
            resultsPanel.classList.add('hidden');
            customPlanBuilder.classList.add('hidden');
            return;
        }
        
        let totalCalories;
        if (gender === 'male') {
            totalCalories = weight * 30; 
        } else {
            totalCalories = weight * 25; 
        }
        
        const proteinGrams = (weight * 1.2).toFixed(1);
        const fatGrams = (totalCalories * 0.25 / 9).toFixed(1);
        const carbGrams = (totalCalories * 0.55 / 4).toFixed(1);
        
        const calciumGrams = 1000; // Updated from 1 gram to 1000 mg
        const vitaminDIU = 600;

        document.getElementById('calories-result').textContent = `${totalCalories.toFixed(0)} سعر حراري`;
        document.getElementById('protein-result').textContent = `${proteinGrams} جرام`;
        document.getElementById('fat-result').textContent = `${fatGrams} جرام`;
        document.getElementById('carb-result').textContent = `${carbGrams} جرام`;
        document.getElementById('calcium-result').textContent = `${calciumGrams} ملجم`; // Changed to mg
        document.getElementById('vitamin-d-result').textContent = `${vitaminDIU} وحدة دولية (IU)`;
        
        resultsPanel.classList.remove('hidden');
        customPlanBuilder.classList.remove('hidden');
        displayAnalysis(totalCalories, proteinGrams, carbGrams, fatGrams);
    }
    
    function displayAnalysis(calories, protein, carbs, fats) {
        const analysisPanel = document.getElementById('analysis-panel');
        const analysisText = document.getElementById('analysis-text');
        
        let analysisContent = `
            <p> بناءً على بياناتك، تقدر احتياجاتك اليومية بحوالي <span class="font-bold text-emerald-600">${calories.toFixed(0)}</span> سعر حراري. هذا هو مقدار الطاقة التي يحتاجها جسمك للحفاظ على وظائفه الأساسية ونشاطك اليومي.</p>
            <p class="mt-4">لتلبية هذه الاحتياجات، يُنصح بتناول:</p>
            <ul class="list-disc list-inside mt-2 space-y-2">
                <li><span class="font-bold text-blue-500">${carbs}</span> جرام من الكربوهيدرات، لتزويد جسمك بالوقود الأساسي.</li>
                <li><span class="font-bold text-red-500">${protein}</span> جرام من البروتينات، لدعم بناء وإصلاح الأنسجة العضلية.</li>
                <li><span class="font-bold text-yellow-500">${fats}</span> جرام من الدهون، وهي ضرورية لوظائف الهرمونات وامتصاص الفيتامينات.</li>
            </ul>
        `;
        analysisText.innerHTML = analysisContent;
        analysisPanel.classList.remove('hidden');
    }
    
    // Gemini API Integration
    async function callGeminiAPI(prompt, title, loaderId) {
        const loader = document.getElementById(loaderId);
        const outputPanel = document.getElementById('ai-output');
        const outputTitle = document.getElementById('ai-output-title');
        const outputContent = document.getElementById('ai-output-content');

        loader.classList.remove('hidden');
        outputPanel.classList.add('hidden');
        
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        let retryCount = 0;
        const maxRetries = 3;
        const baseDelay = 1000;

        async function fetchWithRetry() {
            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: {
                        parts: [{ text: "You are a professional nutritionist. Provide responses in a clear and well-structured format using HTML and Arabic language. Do not include any introductory or concluding sentences outside of the HTML body content. Do not use markdown headers." }]
                    },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API response status: ${response.status}`);
                }
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'تعذر توليد المحتوى. يرجى المحاولة مرة أخرى.';
                
                outputTitle.textContent = title;
                outputContent.innerHTML = text;
                outputPanel.classList.remove('hidden');

            } catch (error) {
                if (retryCount < maxRetries) {
                    retryCount++;
                    const delay = baseDelay * Math.pow(2, retryCount);
                    await new Promise(res => setTimeout(res, delay));
                    await fetchWithRetry();
                } else {
                    outputTitle.textContent = "خطأ";
                    outputContent.textContent = "عذراً، حدث خطأ أثناء الاتصال بالخادم. يرجى المحاولة لاحقاً.";
                    outputPanel.classList.remove('hidden');
                }
            } finally {
                loader.classList.add('hidden');
            }
        }
        await fetchWithRetry();
    }
    
    async function generateMealPlan() {
        const totalCalories = document.getElementById('calories-result').textContent;
        const totalProtein = document.getElementById('total-protein').textContent;
        const totalCarbs = document.getElementById('total-carbs').textContent;
        const totalFats = document.getElementById('total-fats').textContent;
        const totalCalcium = document.getElementById('total-calcium').textContent;
        const age = document.getElementById('age-input').value;
        const weight = document.getElementById('weight-input').value;
        const gender = document.getElementById('gender-select').value === 'male' ? 'ذكر' : 'أنثى';

        const prompt = `
            أنشئ خطة وجبات ليوم واحد لشخص يبلغ من العمر ${age}، وزنه ${weight} كجم، وجنسه ${gender}. يجب أن تستهدف الخطة حوالي ${totalCalories} سعرة حرارية، و${totalProtein} بروتين، و${totalCarbs} كربوهيدرات، و${totalFats} دهون، و${totalCalcium} كالسيوم.
            
            قم بتضمين وجبات الإفطار والغداء والعشاء والوجبات الخفيفة. 
            قدم الخطة بتنسيق HTML، مع استخدام قائمة غير مرتبة (<ul>) لكل وجبة، وعنوان (<h3>) لكل وجبة. استخدم تنسيقات جذابة.
        `;

        await callGeminiAPI(prompt, 'خطتك الغذائية اليومية', 'plan-loader');
    }
    
    async function generateRecipes() {
        const ingredients = myPlan.map(item => item.name).join(', ');

        const prompt = `
            بناءً على المكونات التالية: ${ingredients}.
            قم بتوليد 3 وصفات صحية ومختلفة. لكل وصفة، اذكر:
            - اسم الوصفة (<h3>)
            - قائمة بالمكونات (<ul>)
            - خطوات التحضير (أرقام مرتبة <ol>)
            - نصائح إضافية (اختياري)
            
            قدم الإجابة بتنسيق HTML جذاب ومناسب للعرض على الويب.
        `;

        await callGeminiAPI(prompt, 'وصفات مقترحة', 'recipes-loader');
    }

    document.addEventListener('DOMContentLoaded', () => {
        showSection('macro');
        renderFoodList();
    });

</script>
</body>
</html>

