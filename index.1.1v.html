<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عبود</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: auto;
            max-height: 400px;
        }
        .nutrient-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .nutrient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .details-panel {
            display: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .details-panel.active {
            display: block;
            max-height: 1000px;
        }
        .tab-button {
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-button.active {
            background-color: #10B981;
            color: white;
            border-color: #10B981;
        }
        .food-item-btn {
            transition: transform 0.1s;
        }
        .food-item-btn:active {
            transform: scale(0.95);
        }
        .food-image {
            width: 48px;
            height: 48px;
            border-radius: 9999px;
            object-fit: cover;
            object-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .quantity-control button {
            width: 2rem;
            height: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.1s;
        }
        .quantity-control button:hover {
            background-color: #d1d5db;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10B981;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .shared-plan-box {
            background-color: #f1f5f9;
            border: 1px dashed #94a3b8;
            transition: all 0.3s ease-in-out;
        }
        .shared-plan-box:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .plan-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .plan-details.active {
            max-height: 500px; /* Adjust as needed */
        }
        .shared-needs-box {
            background-color: #e0f2fe;
            border: 1px dashed #60a5fa;
            transition: all 0.3s ease-in-out;
        }
        .shared-needs-box:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .delete-btn {
            background-color: transparent;
            border: none;
            color: #ef4444; /* red-500 */
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
        }
        .delete-btn:hover {
            color: #b91c1c; /* red-700 */
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, top 0.3s;
        }
        .toast.show {
            top: 40px;
            opacity: 1;
            visibility: visible;
        }
        .toast.success {
            background-color: #10B981; /* emerald-500 */
        }
        .toast.error {
            background-color: #EF4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div id="toast-notification" class="toast"></div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-emerald-600">صفحة عبود</h1>
            <p class="mt-4 text-lg text-gray-600">هنا يمكنك إدارة خططك الغذائية ومشاركتها مع الآخرين.</p>
        </header>

        <nav class="flex justify-center mb-12 border-b border-gray-200 pb-4">
            <button id="macro-tab" class="tab-button active text-lg font-semibold py-3 px-6 rounded-t-lg border-b-2 border-transparent" onclick="showSection('macro')">العناصر الغذائية الكبرى</button>
            <button id="micro-tab" class="tab-button text-lg font-semibold py-3 px-6 rounded-t-lg border-b-2 border-transparent" onclick="showSection('micro')">العناصر الغذائية الصغرى</button>
        </nav>

        <main id="main-content">
            <section id="macro-section">
                <div class="text-center mb-12">
                     <h2 class="text-3xl font-bold text-gray-800">ما هي العناصر الغذائية الكبرى؟</h2>
                     <p class="mt-3 max-w-3xl mx-auto text-gray-600">هي العناصر التي يحتاجها الجسم بكميات كبيرة لتوفير الطاقة والنمو وإصلاح الأنسجة. تشمل الكربوهيدرات، البروتينات، والدهون. يوضح الرسم البياني أدناه التوزيع المثالي للسعرات الحرارية اليومية من هذه العناصر.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-center mb-12">
                    <div class="lg:col-span-2">
                         <div class="chart-container">
                            <canvas id="macroChart"></canvas>
                        </div>
                    </div>
                     <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="nutrient-card bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-400" onclick="toggleDetails('carb-details')">
                            <h3 class="text-xl font-bold text-blue-500">الكربوهيدرات</h3>
                            <p class="mt-2 text-gray-600">مصدر الطاقة الرئيسي للجسم والدماغ.</p>
                        </div>
                        <div class="nutrient-card bg-white p-6 rounded-xl shadow-md border-t-4 border-red-400" onclick="toggleDetails('protein-details')">
                            <h3 class="text-xl font-bold text-red-500">البروتينات</h3>
                            <p class="mt-2 text-gray-600">أساسية لبناء وإصلاح العضلات والأنسجة.</p>
                        </div>
                        <div class="nutrient-card bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-400" onclick="toggleDetails('fat-details')">
                             <h3 class="text-xl font-bold text-yellow-500">الدهون</h3>
                             <p class="mt-2 text-gray-600">تدعم الهرمونات وامتصاص الفيتامينات.</p>
                        </div>
                    </div>
                </div>

                <div id="carb-details" class="details-panel mt-8 bg-blue-50 p-6 rounded-lg border border-blue-200">
                    <h4 class="text-2xl font-bold text-blue-600">تفاصيل الكربوهيدرات</h4>
                    <p class="mt-2"><strong>الوظيفة:</strong> هي الوقود المفضل للجسم، وخاصة للدماغ والجهاز العصبي المركزي أثناء ممارسة الرياضة. تنقسم إلى بسيطة ومعقدة.</p>
                    <p class="mt-2"><strong>المصادر الصحية:</strong> الحبوب الكاملة (الشوفان، الأرز البني)، الفواكه، الخضروات النشوية (البطاطا، الذرة)، والبقوليات (العدس، الحمص).</p>
                </div>
                 <div id="protein-details" class="details-panel mt-8 bg-red-50 p-6 rounded-lg border border-red-200">
                    <h4 class="text-2xl font-bold text-red-600">تفاصيل البروتينات</h4>
                    <p class="mt-2"><strong>الوظيفة:</strong> تتكون من أحماض أمينية، وهي ضرورية لنمو الخلايا، وظيفة المناعة، وإنتاج الإنزيمات والهرمونات.</p>
                    <p class="mt-2"><strong>المصادر:</strong> اللحوم الخالية من الدهون، الدواجن، الأسماك، البيض، منتجات الألبان، البقوليات، المكسرات، وبذور الكينوا.</p>
                </div>
                <div id="fat-details" class="details-panel mt-8 bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                    <h4 class="text-2xl font-bold text-yellow-600">تفاصيل الدهون</h4>
                    <p class="mt-2"><strong>الوظيفة:</strong> مصدر طاقة مركز، تساعد في حماية الأعضاء، وتدعم امتصاص الفيتامينات الذائبة في الدهون (A, D, E, K).</p>
                    <p class="mt-2"><strong>المصادر الصحية:</strong> الأفوكادو، زيت الزيتون، المكسرات (اللوز، الجوز)، البذور (الشيا، الكتان)، والأسماك الدهنية (السلمون).</p>
                </div>
                
                <div class="mt-12 bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-400">
                    <h2 class="text-2xl font-bold mb-4 text-center text-emerald-600">البيانات المشتركة</h2>
                    <p class="text-center text-gray-600 mb-6">تصفح الخطط الغذائية التي شاركها المستخدمون الآخرون.</p>
                    <div id="shared-plans-list" class="space-y-4">
                        <!-- Skeleton Loader -->
                        <div id="shared-plans-loader" class="space-y-4">
                            <div class="bg-gray-200 p-4 rounded-lg animate-pulse">
                                <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-300 rounded w-1/2"></div>
                            </div>
                            <div class="bg-gray-200 p-4 rounded-lg animate-pulse">
                                <div class="h-4 bg-gray-300 rounded w-2/3 mb-2"></div>
                                <div class="h-3 bg-gray-300 rounded w-1/3"></div>
                            </div>
                        </div>
                        <!-- Shared plans will be displayed here -->
                        <div id="no-shared-plans" class="text-center text-gray-500 italic hidden">لا توجد خطط غذائية مشتركة بعد. كن أول من يشارك!</div>
                    </div>
                </div>

                <div class="mt-12 bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-400">
                    <h2 class="text-2xl font-bold mb-4 text-center text-emerald-600">حاسبة احتياجاتك اليومية</h2>
                    <p class="text-center text-gray-600 mb-6">أدخل عمرك ووزنك وجنسك لتقدير احتياجاتك اليومية من العناصر الغذائية.</p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                        <div class="w-full sm:w-1/3">
                            <label for="age-input" class="block text-gray-700 font-semibold mb-2">العمر (سنوات)</label>
                            <input type="number" id="age-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" placeholder="مثال: 30" min="1" max="100">
                        </div>
                        <div class="w-full sm:w-1/3">
                            <label for="weight-input" class="block text-gray-700 font-semibold mb-2">الوزن (كجم)</label>
                            <input type="number" id="weight-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" placeholder="مثال: 70" min="1" max="500">
                        </div>
                        <div class="w-full sm:w-1/3">
                            <label for="gender-select" class="block text-gray-700 font-semibold mb-2">الجنس</label>
                            <select id="gender-select" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300">
                                <option value="male">ذكر</option>
                                <option value="female">أنثى</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 text-center flex flex-col sm:flex-row justify-center items-center gap-4">
                        <button onclick="calculateNeeds()" class="bg-emerald-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-emerald-600 transition w-full sm:w-auto">احسب احتياجاتي</button>
                        <button id="save-needs-btn" onclick="saveMyNeeds()" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-600 transition w-full sm:w-auto hidden">حفظ ومشاركة احتياجاتي</button>
                    </div>
                    <div id="results-panel" class="mt-8 p-6 bg-slate-100 rounded-lg shadow-inner hidden">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">الاحتياجات اليومية المقدرة:</h4>
                        <p class="text-sm text-gray-600 mb-4">ملاحظة: تحتاج إلى فيتامين د لضمان امتصاص جسمك للكالسيوم بشكل صحيح.</p>
                        <ul class="space-y-3">
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-gray-700">السعرات الحرارية:</span> <span id="calories-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-blue-500">الكربوهيدرات:</span> <span id="carb-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-red-500">البروتينات:</span> <span id="protein-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-yellow-500">الدهون:</span> <span id="fat-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-purple-500">الكالسيوم:</span> <span id="calcium-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-orange-500">فيتامين د:</span> <span id="vitamin-d-result" class="font-semibold text-gray-800"></span></li>
                        </ul>
                        <div id="analysis-panel" class="mt-6 pt-4 border-t border-gray-300">
                             <h4 class="text-xl font-bold text-gray-800 mb-3">تحليل احتياجاتك:</h4>
                             <p id="analysis-text" class="text-gray-700"></p>
                        </div>
                    </div>

                    <div id="custom-plan-builder" class="mt-12 bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-400 hidden">
                        <h2 class="text-2xl font-bold mb-4 text-center text-emerald-600">اصنع نظامك الغذائي الخاص</h2>
                        <p class="text-center text-gray-600 mb-6">اختر من الأطعمة أدناه لإضافتها إلى خطتك الغذائية اليومية.</p>
                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">قائمة الأطعمة</h3>
                                <div class="mb-4">
                                    <input type="text" id="food-search" placeholder="ابحث عن طعام..." class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300">
                                </div>
                                <div id="food-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 p-4 border border-gray-200 rounded-lg max-h-80 overflow-y-auto">
                                    <!-- Food items will be dynamically generated here -->
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">خطتي الغذائية</h3>
                                <div class="bg-slate-100 rounded-lg p-4 shadow-inner min-h-[10rem] max-h-80 overflow-y-auto">
                                    <ul id="my-plan-list" class="space-y-3">
                                        <!-- Selected food items will be listed here -->
                                    </ul>
                                </div>
                                <div class="mt-4 p-4 bg-emerald-100 rounded-lg border-t-4 border-emerald-400">
                                     <h4 class="font-bold text-lg text-emerald-700 mb-2">الإجمالي:</h4>
                                     <ul class="text-gray-700 space-y-1">
                                         <li class="flex justify-between"><span>السعرات الحرارية:</span> <span id="total-calories-my-plan" class="font-semibold">0</span></li>
                                         <li class="flex justify-between"><span>البروتينات:</span> <span id="total-protein-my-plan" class="font-semibold">0 جرام</span></li>
                                         <li class="flex justify-between"><span>الكربوهيدرات:</span> <span id="total-carbs-my-plan" class="font-semibold">0 جرام</span></li>
                                         <li class="flex justify-between"><span>الدهون:</span> <span id="total-fats-my-plan" class="font-semibold">0 جرام</span></li>
                                         <li class="flex justify-between"><span>الكالسيوم:</span> <span id="total-calcium-my-plan" class="font-semibold">0 ملجم</span></li>
                                     </ul>
                                </div>
                                <div class="mt-4 flex flex-col gap-2">
                                     <button id="generate-plan-btn" onclick="generateMealPlan()" class="bg-purple-500 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-purple-600 transition flex items-center justify-center">
                                         <span class="mr-2">✨</span>
                                         <span>توليد خطة غذائية</span>
                                         <div id="plan-loader" class="loader ml-2 hidden"></div>
                                     </button>
                                     <button id="generate-recipes-btn" onclick="generateRecipes()" class="bg-cyan-500 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-cyan-600 transition flex items-center justify-center">
                                         <span class="mr-2">✨</span>
                                         <span>توليد وصفات</span>
                                         <div id="recipes-loader" class="loader ml-2 hidden"></div>
                                     </button>
                                </div>
                            </div>
                        </div>
                         <div id="ai-output" class="mt-8 p-6 bg-slate-100 rounded-lg shadow-inner hidden">
                            <h4 class="text-xl font-bold text-gray-800 mb-3" id="ai-output-title"></h4>
                            <div id="ai-output-content" class="text-gray-700 space-y-4"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="micro-section" style="display: none;">
                <div class="text-center mb-12">
                     <h2 class="text-3xl font-bold text-gray-800">ما هي العناصر الغذائية الصغرى؟</h2>
                     <p class="mt-3 max-w-3xl mx-auto text-gray-600">هي الفيتامينات والمعادن التي يحتاجها الجسم بكميات أقل، ولكنها حيوية للغاية للوظائف الفسيولوجية الطبيعية، من دعم المناعة إلى صحة العظام. انقر على كل فئة لاستكشافها.</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div id="vitamins-container" class="bg-white p-6 rounded-xl shadow-lg">
                         <h3 class="text-2xl font-bold mb-4 text-center text-emerald-600">الفيتامينات</h3>
                         <div class="space-y-3" id="vitamins-list"></div>
                    </div>
                    <div id="minerals-container" class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-2xl font-bold mb-4 text-center text-emerald-600">المعادن</h3>
                        <div class="space-y-3" id="minerals-list"></div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-16 pt-8 border-t border-gray-200">
            <p class="text-gray-500">تم تصميم هذا الدليل لتوفير معلومات عامة. استشر دائمًا أخصائي تغذية أو طبيبًا للحصول على نصائح شخصية.</p>
            <p id="user-id-display" class="mt-2 text-xs text-gray-400">المستخدم: </p>
        </footer>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, query, where, updateDoc, getDocs, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Firestore Debugging
    setLogLevel('debug');

    // Global Firebase variables
    let app, auth, db, userId;
    let isFirebaseReady = false;

    // Firebase configuration from the environment
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // A global variable to hold the nutrition plan.
    let myPlan = [];
    const MY_PLAN_DOC_ID = 'my-plan-doc';
    
    let sharedPlansList, noSharedPlansDiv, sharedPlansLoader;

    // Initialize Firebase
    if (Object.keys(firebaseConfig).length > 0) {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Firebase Authenticated. User ID:", userId);
                document.getElementById('user-id-display').textContent = `المستخدم: ${userId}`;
                isFirebaseReady = true;
                await initializeCollaboration();
            } else {
                console.log("Firebase Auth State Changed. Signing in.");
                try {
                     if (initialAuthToken) {
                         await signInWithCustomToken(auth, initialAuthToken);
                     } else {
                         await signInAnonymously(auth);
                     }
                } catch (error) {
                    console.error("Error during authentication:", error);
                }
            }
        });
    } else {
        console.error("Firebase config is missing. Collaboration features will not work.");
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        sharedPlansList = document.getElementById('shared-plans-list');
        noSharedPlansDiv = document.getElementById('no-shared-plans');
        sharedPlansLoader = document.getElementById('shared-plans-loader');
        
        document.getElementById('food-search').addEventListener('keyup', handleSearch);

        showSection('macro');
        renderFoodList(foodDatabase);
    });

    async function initializeCollaboration() {
        if (!isFirebaseReady) {
            console.error("Firebase is not ready yet.");
            return;
        }

        // Listen for real-time updates to all shared plans
        const sharedPlansCollection = collection(db, 'artifacts', appId, 'public', 'data', 'nutrition_plans');
        onSnapshot(sharedPlansCollection, (querySnapshot) => {
            const sharedPlans = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const id = doc.id;
                if (data.type === 'meal_plan' && typeof data.plan === 'string') {
                    try {
                        data.plan = JSON.parse(data.plan);
                        sharedPlans.push({ id, ...data });
                    } catch (e) {
                        console.error("Failed to parse shared meal plan data from Firestore:", e);
                    }
                } else {
                    sharedPlans.push({ id, ...data });
                }
            });
            renderSharedPlans(sharedPlans);
        }, (error) => {
            console.error("Error getting real-time updates for shared plans:", error);
            if(sharedPlansLoader) sharedPlansLoader.style.display = 'none';
        });

        // Listen for real-time updates to my personal plan
        const myPlanDocRef = doc(db, 'artifacts', appId, 'users', userId, 'my_nutrition_plan', MY_PLAN_DOC_ID);
        onSnapshot(myPlanDocRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                if (data.plan && typeof data.plan === 'string') {
                    try {
                        myPlan = JSON.parse(data.plan);
                        updatePlanDisplay();
                    } catch (e) {
                        console.error("Failed to parse my plan data from Firestore:", e);
                    }
                }
            } else {
                console.log("No personal plan found, starting with an empty one.");
                myPlan = [];
                updatePlanDisplay();
            }
        }, (error) => {
            console.error("Error getting real-time updates for my plan:", error);
        });
    }

    async function saveMyPlanToFirestore() {
        if (!isFirebaseReady) {
            console.error("Firebase is not ready, cannot save data.");
            return;
        }
        try {
            const myPlanDocRef = doc(db, 'artifacts', appId, 'users', userId, 'my_nutrition_plan', MY_PLAN_DOC_ID);
            const serializedPlan = JSON.stringify(myPlan);
            await setDoc(myPlanDocRef, {
                plan: serializedPlan,
                lastUpdated: new Date()
            }, { merge: true });
            console.log("My plan saved successfully!");
        } catch (e) {
            console.error("Error adding my plan document: ", e);
        }
    }

    async function saveSharedPlanToFirestore() {
        if (!isFirebaseReady) {
            console.error("Firebase is not ready, cannot save data.");
            return;
        }
        try {
            const sharedPlansCollection = collection(db, 'artifacts', appId, 'public', 'data', 'nutrition_plans');
            const serializedPlan = JSON.stringify(myPlan);
            await addDoc(sharedPlansCollection, {
                userId: userId,
                plan: serializedPlan,
                totalCalories: calculateTotalCalories(myPlan),
                type: 'meal_plan',
                lastUpdated: new Date()
            });
            showToast("تمت مشاركة خطتك بنجاح!");
            console.log("Shared plan saved successfully!");
        } catch (e) {
            console.error("Error adding shared plan document: ", e);
            showToast("حدث خطأ أثناء مشاركة الخطة.", 'error');
        }
    }

    window.saveMyNeeds = async function() {
        if (!isFirebaseReady) {
            showToast("خدمة المزامنة غير جاهزة، يرجى المحاولة لاحقاً.", 'error');
            return;
        }
        
        const age = parseInt(document.getElementById('age-input').value);
        const weight = parseInt(document.getElementById('weight-input').value);
        const gender = document.getElementById('gender-select').value;
        const totalCalories = document.getElementById('calories-result').textContent;
        const totalProtein = document.getElementById('protein-result').textContent;
        const totalCarbs = document.getElementById('carb-result').textContent;
        const totalFats = document.getElementById('fat-result').textContent;

        if (isNaN(age) || isNaN(weight) || age <= 0 || weight <= 0) {
            showToast("يرجى حساب احتياجاتك أولاً.", 'error');
            return;
        }
        
        try {
            const sharedPlansCollection = collection(db, 'artifacts', appId, 'public', 'data', 'nutrition_plans');
            await addDoc(sharedPlansCollection, {
                userId: userId,
                age: age,
                weight: weight,
                gender: gender,
                calories: totalCalories,
                protein: totalProtein,
                carbs: totalCarbs,
                fats: totalFats,
                type: 'calculated_needs',
                lastUpdated: new Date()
            });
            showToast("تم حفظ ومشاركة بياناتك بنجاح!");
            console.log("Calculated needs saved successfully!");
        } catch (e) {
            console.error("Error saving calculated needs: ", e);
            showToast("حدث خطأ أثناء حفظ البيانات.", 'error');
        }
    }
    
    window.deletePlan = async function(planId) {
        if (!isFirebaseReady) {
            showToast("خدمة المزامنة غير جاهزة، يرجى المحاولة لاحقاً.", 'error');
            return;
        }
        try {
            const planDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'nutrition_plans', planId);
            await deleteDoc(planDocRef);
            showToast("تم حذف الخطة بنجاح.");
            console.log(`Plan ${planId} deleted successfully!`);
        } catch (e) {
            console.error("Error deleting plan document: ", e);
            showToast("حدث خطأ أثناء حذف الخطة.", 'error');
        }
    }
    
    function renderSharedPlans(plans) {
        if (!sharedPlansList || !noSharedPlansDiv || !sharedPlansLoader) {
            return;
        }
        
        sharedPlansLoader.style.display = 'none';
        sharedPlansList.innerHTML = '';
        
        if (plans.length === 0) {
            noSharedPlansDiv.classList.remove('hidden');
            sharedPlansList.appendChild(noSharedPlansDiv);
            return;
        } 
        
        noSharedPlansDiv.classList.add('hidden');

        plans.forEach((planData) => {
            const planBox = document.createElement('div');
            const isOwner = planData.userId === userId;
            const deleteButtonHTML = isOwner ? `<button class="delete-btn" onclick="deletePlan('${planData.id}')" title="حذف">&times;</button>` : '';
            
            if (planData.type === 'calculated_needs') {
                planBox.className = 'shared-needs-box bg-blue-100 p-4 rounded-lg shadow-sm border-t-2 border-blue-300';
                planBox.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <span class="font-bold text-gray-700">احتياجات مقدرة من: <span class="font-mono text-xs text-gray-500">${planData.userId}</span></span>
                            <div class="text-sm text-gray-600 mt-1">السعرات الحرارية: ${planData.calories}</div>
                        </div>
                        ${deleteButtonHTML}
                    </div>
                    <div class="mt-4 text-sm text-gray-700 space-y-1">
                        <p><strong>العمر:</strong> ${planData.age} سنة، <strong>الوزن:</strong> ${planData.weight} كجم</p>
                        <p><strong>البروتين:</strong> ${planData.protein}، <strong>الكربوهيدرات:</strong> ${planData.carbs}، <strong>الدهون:</strong> ${planData.fats}</p>
                    </div>
                `;
            } else { // Assumed to be 'meal_plan'
                planBox.className = 'shared-plan-box bg-slate-100 p-4 rounded-lg shadow-sm border-t-2 border-slate-300';
                planBox.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1 cursor-pointer" onclick="toggleSharedPlanDetails('plan-details-${planData.id}')">
                            <span class="font-bold text-gray-700">خطة من المستخدم: <span class="font-mono text-xs text-gray-500">${planData.userId}</span></span>
                            <div class="text-sm text-gray-600 mt-1">السعرات الحرارية: ${planData.totalCalories}</div>
                        </div>
                        <div class="flex items-center gap-4">
                            ${deleteButtonHTML}
                            <span class="text-xl text-gray-500 transform transition-transform duration-300 rotate-0 cursor-pointer" onclick="toggleSharedPlanDetails('plan-details-${planData.id}')" id="arrow-${planData.id}">+</span>
                        </div>
                    </div>
                    <div id="plan-details-${planData.id}" class="plan-details mt-4">
                        <ul class="space-y-2 text-sm text-gray-700">
                        </ul>
                    </div>
                `;
                const detailsList = planBox.querySelector('ul');
                if (detailsList && Array.isArray(planData.plan)) {
                    planData.plan.forEach(foodItem => {
                        const item = document.createElement('li');
                        item.className = 'flex justify-between items-center bg-white p-2 rounded';
                        item.innerHTML = `
                            <span>${foodItem.name}</span>
                            <span class="font-semibold text-gray-600">${foodItem.quantity} وحدة</span>
                        `;
                        detailsList.appendChild(item);
                    });
                }
            }
            sharedPlansList.appendChild(planBox);
        });
    }
    
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        if (!toast) return;
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    window.toggleSharedPlanDetails = function(id) {
        const details = document.getElementById(id);
        const arrowId = `arrow-${id.split('-')[2]}`;
        const arrow = document.getElementById(arrowId);
        
        if (!details) return;
        
        if (details.classList.contains('active')) {
            details.classList.remove('active');
            if (arrow) arrow.style.transform = 'rotate(0deg)';
        } else {
            details.classList.add('active');
            if (arrow) arrow.style.transform = 'rotate(45deg)';
        }
    }

    // --- Existing JavaScript from previous version, updated for Firebase ---
    
    const macroChartCtx = document.getElementById('macroChart').getContext('2d');
    const macroChart = new Chart(macroChartCtx, {
        type: 'doughnut',
        data: {
            labels: ['الكربوهيدرات', 'البروتينات', 'الدهون'],
            datasets: [{
                label: 'توزيع السعرات الحرارية',
                data: [50, 20, 30],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(248, 113, 113, 0.7)',
                    'rgba(251, 191, 36, 0.7)'
                ],
                borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(248, 113, 113, 1)',
                    'rgba(251, 191, 36, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            family: 'Cairo',
                            size: 14
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += context.parsed + '% من السعرات اليومية';
                            }
                            return label;
                        }
                    },
                    bodyFont: {
                        family: 'Cairo'
                    },
                    titleFont: {
                        family: 'Cairo'
                    }
                }
            }
        }
    });

    let activeDetailsPanel = null;
    
    window.toggleDetails = function(panelId) {
        const panel = document.getElementById(panelId);
        
        if(activeDetailsPanel && activeDetailsPanel !== panel) {
            activeDetailsPanel.classList.remove('active');
        }

        panel.classList.toggle('active');

        if (panel.classList.contains('active')) {
            activeDetailsPanel = panel;
        } else {
            activeDetailsPanel = null;
        }
    }

    window.showSection = function(section) {
        const macroSection = document.getElementById('macro-section');
        const microSection = document.getElementById('micro-section');
        const macroTab = document.getElementById('macro-tab');
        const microTab = document.getElementById('micro-tab');

        if (macroSection) macroSection.style.display = (section === 'macro' ? 'block' : 'none');
        if (microSection) microSection.style.display = (section === 'micro' ? 'block' : 'none');
        if (macroTab) macroTab.classList.toggle('active', section === 'macro');
        if (microTab) microTab.classList.toggle('active', section === 'micro');
    }
    
    const micronutrients = {
        vitamins: [
            { name: "فيتامين أ", description: "ضروري للرؤية، وظيفة المناعة، وصحة الجلد.", sources: "الجزر، البطاطا الحلوة، السبانخ." },
            { name: "فيتامين د", description: "يساعد على امتصاص الكالسيوم لصحة العظام.", sources: "أشعة الشمس، الأسماك الدهنية، الحليب المدعم." },
            { name: "فيتامين هـ", description: "مضاد للأكسدة يحمي الخلايا من التلف.", sources: "المكسرات، البذور، زيت عباد الشمس." },
            { name: "فيتامين ك", description: "مهم لتخثر الدم وصحة العظام.", sources: "الخضروات الورقية الخضراء (الكرنب، السبانخ)." },
            { name: "فيتامين ج", description: "يعزز جهاز المناعة ويساعد في إنتاج الكولاجين.", sources: "الحمضيات (البرتقال)، الفراولة، الفلفل." },
            { name: "فيتامينات ب", description: "مجموعة فيتامينات تساعد في استقلاب الطاقة ووظائف الدماغ.", sources: "الحبوب الكاملة، اللحوم، البيض، البقوليات." }
        ],
        minerals: [
            { name: "الكالسيوم", description: "أساسي لبناء عظام وأسنان قوية.", sources: "منتجات الألبان، البروكلي، اللوز." },
            { name: "الحديد", description: "ينقل الأكسجين في الدم ويمنع فقر الدم.", sources: "اللحوم الحمراء، السبانخ، العدس." },
            { name: "البوتاسيوم", description: "ينظم توازن السوائل وضغط الدم.", sources: "الموز، البطاطا، الأفوكادو." },
            { name: "المغنيسيوم", description: "يشارك في أكثر من 300 تفاعل إنزيمي في الجسم.", sources: "المكسرات، البذور، الشوكولاتة الداكنة." },
            { name: "الزنك", description: "يدعم وظيفة المناعة والتئام الجروح.", sources: "اللحوم، المحار، بذور اليقطين." },
            { name: "اليود", description: "ضروري لوظيفة الغدة الدرقية الصحية.", sources: "ملح الطعام المدعم باليود، الأعشاب البحرية، الأسماك." }
        ]
    };

    window.createMicroNutrientList = function(data, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = ''; // Clear previous content
        data.forEach((item) => {
            const wrapper = document.createElement('div');
            const button = document.createElement('button');
            button.className = 'w-full text-right p-3 bg-gray-100 rounded-lg font-semibold hover:bg-emerald-100 transition flex justify-between items-center';
            button.innerHTML = `<span>${item.name}</span> <span class="plus-icon text-emerald-500 font-bold text-xl">+</span>`;
            
            const details = document.createElement('div');
            details.className = 'details-panel p-4 bg-white border-l-4 border-emerald-200';
            details.innerHTML = `
                <p><strong>الوظيفة:</strong> ${item.description}</p>
                <p class="mt-2"><strong>أبرز المصادر:</strong> ${item.sources}</p>
            `;

            button.onclick = () => {
                const isActive = details.classList.contains('active');
                
                document.querySelectorAll(`#${containerId} .details-panel`).forEach(p => p.classList.remove('active'));
                document.querySelectorAll(`#${containerId} .plus-icon`).forEach(icon => icon.textContent = '+');

                if (!isActive) {
                    details.classList.add('active');
                    button.querySelector('.plus-icon').textContent = '-';
                }
            };
            
            wrapper.appendChild(button);
            wrapper.appendChild(details);
            container.appendChild(wrapper);
        });
    }

    createMicroNutrientList(micronutrients.vitamins, 'vitamins-list');
    createMicroNutrientList(micronutrients.minerals, 'minerals-list');
    
    // Food data with improved image placeholders
    const foodDatabase = [
        { name: 'صدر دجاج (100ج)', calories: 165, protein: 31, carbs: 0, fats: 3.6, calcium: 10, image: { emoji: '🐔', color: 'f59e0b' } },
        { name: 'بيض مسلوق (1 بيضة كبيرة)', calories: 78, protein: 6.3, carbs: 0.6, fats: 5.3, calcium: 25, image: { emoji: '🥚', color: 'fef3c7' } },
        { name: 'أرز أبيض مطبوخ (100ج)', calories: 130, protein: 2.7, carbs: 28, fats: 0.3, calcium: 15, image: { emoji: '🍚', color: 'e5e7eb' } },
        { name: 'خبز قمح كامل (شريحة)', calories: 82, protein: 4, carbs: 14.8, fats: 1.1, calcium: 30, image: { emoji: '🍞', color: 'd97706' } },
        { name: 'عدس مطبوخ (100ج)', calories: 116, protein: 9, carbs: 20, fats: 0.4, calcium: 19, image: { emoji: '🥣', color: 'ca8a04' } },
        { name: 'سبانخ (100ج)', calories: 23, protein: 2.9, carbs: 3.6, fats: 0.4, calcium: 99, image: { emoji: '🌿', color: '16a34a' } },
        { name: 'تفاح (100ج)', calories: 52, protein: 0.3, carbs: 13.8, fats: 0.2, calcium: 6, image: { emoji: '🍎', color: 'ef4444' } },
        { name: 'بروكلي (100ج)', calories: 34, protein: 2.8, carbs: 6.6, fats: 0.4, calcium: 47, image: { emoji: '🥦', color: '22c55e' } },
        { name: 'أفوكادو (100ج)', calories: 160, protein: 2, carbs: 8.5, fats: 14.7, calcium: 12, image: { emoji: '🥑', color: '84cc16' } },
        { name: 'زيت زيتون (ملعقة كبيرة)', calories: 119, protein: 0, carbs: 0, fats: 13.5, calcium: 0, image: { emoji: '🫒', color: 'ca8a04' } },
        { name: 'لوز (100ج)', calories: 579, protein: 21, carbs: 21.5, fats: 49.9, calcium: 264, image: { emoji: '🌰', color: 'a16207' } },
        { name: 'زبادي يوناني (100ج)', calories: 59, protein: 10, carbs: 3.6, fats: 0.4, calcium: 101, image: { emoji: '🍦', color: 'e0f2fe' } },
        { name: 'قهوة سادة (240 مل)', calories: 2, protein: 0.3, carbs: 0, fats: 0, calcium: 5, image: { emoji: '☕', color: '44403c' } },
        { name: 'حليب بقري (240 مل)', calories: 149, protein: 8, carbs: 12, fats: 8, calcium: 300, image: { emoji: '🥛', color: 'f8fafc' } },
        { name: 'سلمون مطبوخ (100ج)', calories: 208, protein: 20, carbs: 0, fats: 13, calcium: 10, image: { emoji: '🐟', color: 'f97316' } },
        { name: 'بطاطا حلوة مطبوخة (100ج)', calories: 76, protein: 1.5, carbs: 17.7, fats: 0.1, calcium: 30, image: { emoji: '🍠', color: 'ea580c' } },
        { name: 'لحمة (100غ)', calories: 250, protein: 26, carbs: 0, fats: 17, calcium: 18, image: { emoji: '🥩', color: 'dc2626' } },
        { name: 'بطاطا (100غ)', calories: 77, protein: 2, carbs: 17, fats: 0.1, calcium: 12, image: { emoji: '🥔', color: 'facc15' } },
        { name: 'سردين بالزيت (100غ)', calories: 255, protein: 22.3, carbs: 0, fats: 14.5, calcium: 24, image: { emoji: '🐟', color: '64748b' } }
    ];

    function handleSearch(event) {
        const searchTerm = event.target.value.toLowerCase().trim();
        const filteredFoods = foodDatabase.filter(food => 
            food.name.toLowerCase().includes(searchTerm)
        );
        renderFoodList(filteredFoods);
    }
    
    function renderFoodList(foods) {
        const foodListContainer = document.getElementById('food-list');
        if (!foodListContainer) return;
        foodListContainer.innerHTML = '';
        foods.forEach(food => {
            const button = document.createElement('button');
            button.className = 'food-item-btn flex flex-col items-center justify-center p-4 bg-gray-100 rounded-xl shadow hover:bg-emerald-100 transition-colors cursor-pointer';
            
            button.innerHTML = `
                <div class="food-image" style="background-color:#${food.image.color};">${food.image.emoji}</div>
                <span class="text-sm font-semibold text-gray-800 text-center mt-2">${food.name}</span>
                <span class="text-xs text-gray-500 mt-1">${food.calories} سعر حراري</span>
            `;
            button.onclick = () => addFoodToPlan(food);
            foodListContainer.appendChild(button);
        });
    }

    function addFoodToPlan(food) {
        const existingFood = myPlan.find(item => item.name === food.name);
        if (existingFood) {
            existingFood.quantity++;
        } else {
            myPlan.push({ ...food, quantity: 1 });
        }
        updatePlanDisplay();
        saveMyPlanToFirestore();
    }
    
    function calculateTotalCalories(plan) {
        return plan.reduce((total, item) => total + (item.calories || 0) * item.quantity, 0);
    }
    
    function updatePlanDisplay() {
        const myPlanList = document.getElementById('my-plan-list');
        if (!myPlanList) return;
        myPlanList.innerHTML = '';
        
        let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFats = 0, totalCalcium = 0;

        myPlan.forEach((item, index) => {
            totalCalories += (item.calories || 0) * item.quantity;
            totalProtein += (item.protein || 0) * item.quantity;
            totalCarbs += (item.carbs || 0) * item.quantity;
            totalFats += (item.fats || 0) * item.quantity;
            totalCalcium += (item.calcium || 0) * item.quantity;

            const listItem = document.createElement('li');
            listItem.className = 'flex justify-between items-center bg-white p-3 rounded-lg shadow-sm text-sm';
            listItem.innerHTML = `
                <div>
                    <span class="font-bold text-gray-700">${item.name}</span>
                    <span class="text-xs text-gray-500 block">
                        (${item.calories} س، ${item.protein}ب، ${item.carbs}ك، ${item.fats}د)
                    </span>
                </div>
                <div class="quantity-control">
                    <button onclick="changeQuantity(${index}, -1)" class="text-gray-600 font-bold">-</button>
                    <span class="px-2 text-gray-800">${item.quantity}</span>
                    <button onclick="changeQuantity(${index}, 1)" class="text-gray-600 font-bold">+</button>
                </div>
            `;
            myPlanList.appendChild(listItem);
        });

        document.getElementById('total-calories-my-plan').textContent = totalCalories.toFixed(0);
        document.getElementById('total-protein-my-plan').textContent = `${totalProtein.toFixed(1)} جرام`;
        document.getElementById('total-carbs-my-plan').textContent = `${totalCarbs.toFixed(1)} جرام`;
        document.getElementById('total-fats-my-plan').textContent = `${totalFats.toFixed(1)} جرام`;
        document.getElementById('total-calcium-my-plan').textContent = `${totalCalcium.toFixed(0)} ملجم`;
    }

    window.changeQuantity = function(index, change) {
        if (myPlan[index].quantity + change > 0) {
            myPlan[index].quantity += change;
        } else {
            myPlan.splice(index, 1);
        }
        updatePlanDisplay();
        saveMyPlanToFirestore();
    }

    window.calculateNeeds = function() {
        const age = parseInt(document.getElementById('age-input').value);
        const weight = parseInt(document.getElementById('weight-input').value);
        const gender = document.getElementById('gender-select').value;
        const resultsPanel = document.getElementById('results-panel');
        const customPlanBuilder = document.getElementById('custom-plan-builder');
        const saveNeedsBtn = document.getElementById('save-needs-btn');
        
        if (isNaN(age) || isNaN(weight) || age <= 0 || weight <= 0) {
            showToast("الرجاء إدخال العمر والوزن بشكل صحيح.", 'error');
            if (resultsPanel) resultsPanel.classList.add('hidden');
            if (customPlanBuilder) customPlanBuilder.classList.add('hidden');
            if (saveNeedsBtn) saveNeedsBtn.classList.add('hidden');
            return;
        }
        
        let totalCalories;
        if (gender === 'male') {
            totalCalories = weight * 30; 
        } else {
            totalCalories = weight * 25; 
        }
        
        const proteinGrams = (weight * 1.2).toFixed(1);
        const fatGrams = (totalCalories * 0.25 / 9).toFixed(1);
        const carbGrams = (totalCalories * 0.55 / 4).toFixed(1);
        
        const calciumGrams = 1000;
        const vitaminDIU = 600;

        document.getElementById('calories-result').textContent = `${totalCalories.toFixed(0)} سعر حراري`;
        document.getElementById('protein-result').textContent = `${proteinGrams} جرام`;
        document.getElementById('fat-result').textContent = `${fatGrams} جرام`;
        document.getElementById('carb-result').textContent = `${carbGrams} جرام`;
        document.getElementById('calcium-result').textContent = `${calciumGrams} ملجم`;
        document.getElementById('vitamin-d-result').textContent = `${vitaminDIU} وحدة دولية (IU)`;
        
        if (resultsPanel) resultsPanel.classList.remove('hidden');
        if (customPlanBuilder) customPlanBuilder.classList.remove('hidden');
        if (saveNeedsBtn) saveNeedsBtn.classList.remove('hidden');
        displayAnalysis(totalCalories, proteinGrams, carbGrams, fatGrams);
    }
    
    window.displayAnalysis = function(calories, protein, carbs, fats) {
        const analysisPanel = document.getElementById('analysis-panel');
        const analysisText = document.getElementById('analysis-text');
        
        if (!analysisPanel || !analysisText) return;

        let analysisContent = `
            <p> بناءً على بياناتك، تقدر احتياجاتك اليومية بحوالي <span class="font-bold text-emerald-600">${calories.toFixed(0)}</span> سعر حراري. هذا هو مقدار الطاقة التي يحتاجها جسمك للحفاظ على وظائفه الأساسية ونشاطك اليومي.</p>
            <p class="mt-4">لتلبية هذه الاحتياجات، يُنصح بتناول:</p>
            <ul class="list-disc list-inside mt-2 space-y-2">
                <li><span class="font-bold text-blue-500">${carbs}</span> جرام من الكربوهيدرات، لتزويد جسمك بالوقود الأساسي.</li>
                <li><span class="font-bold text-red-500">${protein}</span> جرام من البروتينات، لدعم بناء وإصلاح الأنسجة العضلية.</li>
                <li><span class="font-bold text-yellow-500">${fats}</span> جرام من الدهون، وهي ضرورية لوظائف الهرمونات وامتصاص الفيتامينات.</li>
            </ul>
        `;
        analysisText.innerHTML = analysisContent;
        analysisPanel.classList.remove('hidden');
    }
    
    // Gemini API Integration
    async function callGeminiAPI(prompt, title, loaderId) {
        const loader = document.getElementById(loaderId);
        const outputPanel = document.getElementById('ai-output');
        const outputTitle = document.getElementById('ai-output-title');
        const outputContent = document.getElementById('ai-output-content');

        if (!loader || !outputPanel || !outputTitle || !outputContent) {
            console.error("One of the AI output elements is missing.");
            return;
        }

        loader.classList.remove('hidden');
        outputPanel.classList.add('hidden');
        
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        let retryCount = 0;
        const maxRetries = 3;
        const baseDelay = 1000;

        async function fetchWithRetry() {
            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: {
                        parts: [{ text: "You are a professional nutritionist. Provide responses in a clear and well-structured format using HTML and Arabic language. Do not include any introductory or concluding sentences outside of the HTML body content. Do not use markdown headers." }]
                    },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API response status: ${response.status}`);
                }
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'تعذر توليد المحتوى. يرجى المحاولة مرة أخرى.';
                
                outputTitle.textContent = title;
                outputContent.innerHTML = text;
                outputPanel.classList.remove('hidden');

            } catch (error) {
                if (retryCount < maxRetries) {
                    retryCount++;
                    const delay = baseDelay * Math.pow(2, retryCount);
                    await new Promise(res => setTimeout(res, delay));
                    await fetchWithRetry();
                } else {
                    outputTitle.textContent = "خطأ";
                    outputContent.textContent = "عذراً، حدث خطأ أثناء الاتصال بالخادم. يرجى المحاولة لاحقاً.";
                    outputPanel.classList.remove('hidden');
                }
            } finally {
                loader.classList.add('hidden');
            }
        }
        await fetchWithRetry();
    }
    
    window.generateMealPlan = async function() {
        if (myPlan.length === 0) {
            showToast("يجب أن تحتوي خطتك على عنصر واحد على الأقل للمشاركة.", 'error');
            return;
        }
        
        const totalCalories = document.getElementById('calories-result').textContent;
        const totalProtein = document.getElementById('protein-result').textContent;
        const totalCarbs = document.getElementById('carb-result').textContent;
        const totalFats = document.getElementById('fat-result').textContent;
        const totalCalcium = document.getElementById('calcium-result').textContent;
        const age = document.getElementById('age-input').value;
        const weight = document.getElementById('weight-input').value;
        const gender = document.getElementById('gender-select').value === 'male' ? 'ذكر' : 'أنثى';

        const prompt = `
            أنشئ خطة وجبات ليوم واحد لشخص يبلغ من العمر ${age}، وزنه ${weight} كجم، وجنسه ${gender}. يجب أن تستهدف الخطة حوالي ${totalCalories} سعرة حرارية، و${totalProtein} بروتين، و${totalCarbs} كربوهيدرات، و${totalFats} دهون، و${totalCalcium} كالسيوم.
            
            قم بتضمين وجبات الإفطار والغداء والعشاء والوجبات الخفيفة. 
            قدم الخطة بتنسيق HTML، مع استخدام قائمة غير مرتبة (<ul>) لكل وجبة، وعنوان (<h3>) لكل وجبة. استخدم تنسيقات جذابة.
        `;
        
        await saveSharedPlanToFirestore();

        await callGeminiAPI(prompt, 'خطتك الغذائية اليومية', 'plan-loader');
    }
    
    window.generateRecipes = async function() {
         if (myPlan.length === 0) {
            showToast("أضف بعض المكونات إلى خطتك أولاً.", 'error');
            return;
        }
        
        const ingredients = myPlan.map(item => item.name).join(', ');

        const prompt = `
            بناءً على المكونات التالية: ${ingredients}.
            قم بتوليد 3 وصفات صحية ومختلفة. لكل وصفة، اذكر:
            - اسم الوصفة (<h3>)
            - قائمة بالمكونات (<ul>)
            - خطوات التحضير (أرقام مرتبة <ol>)
            - نصائح إضافية (اختياري)
            
            قدم الإجابة بتنسيق HTML جذاب ومناسب للعرض على الويب.
        `;

        await callGeminiAPI(prompt, 'وصفات مقترحة', 'recipes-loader');
    }

</script>
</body>
</html>

