<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¹Ø¨ÙˆØ¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: auto;
            max-height: 400px;
        }
        .nutrient-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
        }
        .nutrient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .details-panel {
            display: none;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .details-panel.active {
            display: block;
            max-height: 1000px;
        }
        .tab-button {
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-button.active {
            background-color: #10B981;
            color: white;
            border-color: #10B981;
        }
        .food-item-btn {
            transition: transform 0.1s;
        }
        .food-item-btn:active {
            transform: scale(0.95);
        }
        .food-image {
            width: 48px;
            height: 48px;
            border-radius: 9999px;
            object-fit: cover;
            object-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .quantity-control button {
            width: 2rem;
            height: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.1s;
        }
        .quantity-control button:hover {
            background-color: #d1d5db;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10B981;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .shared-plan-box {
            background-color: #f1f5f9;
            border: 1px dashed #94a3b8;
            transition: all 0.3s ease-in-out;
        }
        .shared-plan-box:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .plan-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .plan-details.active {
            max-height: 500px; /* Adjust as needed */
        }
        .shared-needs-box {
            background-color: #e0f2fe;
            border: 1px dashed #60a5fa;
            transition: all 0.3s ease-in-out;
        }
        .shared-needs-box:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .delete-btn {
            background-color: transparent;
            border: none;
            color: #ef4444; /* red-500 */
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
            line-height: 1;
        }
        .delete-btn:hover {
            color: #b91c1c; /* red-700 */
        }
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            border-radius: 8px;
            color: white;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, top 0.3s;
        }
        .toast.show {
            top: 40px;
            opacity: 1;
            visibility: visible;
        }
        .toast.success {
            background-color: #10B981; /* emerald-500 */
        }
        .toast.error {
            background-color: #EF4444; /* red-500 */
        }
    </style>
</head>
<body class="bg-slate-50 text-gray-800">

    <div id="toast-notification" class="toast"></div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-emerald-600">ØµÙØ­Ø© Ø¹Ø¨ÙˆØ¯</h1>
            <p class="mt-4 text-lg text-gray-600">Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø®Ø·Ø·Ùƒ Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© ÙˆÙ…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†.</p>
        </header>

        <nav class="flex justify-center mb-12 border-b border-gray-200 pb-4">
            <button id="macro-tab" class="tab-button active text-lg font-semibold py-3 px-6 rounded-t-lg border-b-2 border-transparent" onclick="showSection('macro')">Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„ÙƒØ¨Ø±Ù‰</button>
            <button id="micro-tab" class="tab-button text-lg font-semibold py-3 px-6 rounded-t-lg border-b-2 border-transparent" onclick="showSection('micro')">Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„ØµØºØ±Ù‰</button>
        </nav>

        <main id="main-content">
            <section id="macro-section">
                <div class="text-center mb-12">
                     <h2 class="text-3xl font-bold text-gray-800">Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„ÙƒØ¨Ø±Ù‰ØŸ</h2>
                     <p class="mt-3 max-w-3xl mx-auto text-gray-600">Ù‡ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ ÙŠØ­ØªØ§Ø¬Ù‡Ø§ Ø§Ù„Ø¬Ø³Ù… Ø¨ÙƒÙ…ÙŠØ§Øª ÙƒØ¨ÙŠØ±Ø© Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø·Ø§Ù‚Ø© ÙˆØ§Ù„Ù†Ù…Ùˆ ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ù†Ø³Ø¬Ø©. ØªØ´Ù…Ù„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§ØªØŒ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†Ø§ØªØŒ ÙˆØ§Ù„Ø¯Ù‡ÙˆÙ†. ÙŠÙˆØ¶Ø­ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø£Ø¯Ù†Ø§Ù‡ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù†Ø§ØµØ±.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8 items-center mb-12">
                    <div class="lg:col-span-2">
                         <div class="chart-container">
                            <canvas id="macroChart"></canvas>
                        </div>
                    </div>
                     <div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="nutrient-card bg-white p-6 rounded-xl shadow-md border-t-4 border-blue-400" onclick="toggleDetails('carb-details')">
                            <h3 class="text-xl font-bold text-blue-500">Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</h3>
                            <p class="mt-2 text-gray-600">Ù…ØµØ¯Ø± Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø¬Ø³Ù… ÙˆØ§Ù„Ø¯Ù…Ø§Øº.</p>
                        </div>
                        <div class="nutrient-card bg-white p-6 rounded-xl shadow-md border-t-4 border-red-400" onclick="toggleDetails('protein-details')">
                            <h3 class="text-xl font-bold text-red-500">Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†Ø§Øª</h3>
                            <p class="mt-2 text-gray-600">Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ø¶Ù„Ø§Øª ÙˆØ§Ù„Ø£Ù†Ø³Ø¬Ø©.</p>
                        </div>
                        <div class="nutrient-card bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-400" onclick="toggleDetails('fat-details')">
                             <h3 class="text-xl font-bold text-yellow-500">Ø§Ù„Ø¯Ù‡ÙˆÙ†</h3>
                             <p class="mt-2 text-gray-600">ØªØ¯Ø¹Ù… Ø§Ù„Ù‡Ø±Ù…ÙˆÙ†Ø§Øª ÙˆØ§Ù…ØªØµØ§Øµ Ø§Ù„ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª.</p>
                        </div>
                    </div>
                </div>

                <div id="carb-details" class="details-panel mt-8 bg-blue-50 p-6 rounded-lg border border-blue-200">
                    <h4 class="text-2xl font-bold text-blue-600">ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</h4>
                    <p class="mt-2"><strong>Ø§Ù„ÙˆØ¸ÙŠÙØ©:</strong> Ù‡ÙŠ Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ø§Ù„Ù…ÙØ¶Ù„ Ù„Ù„Ø¬Ø³Ù…ØŒ ÙˆØ®Ø§ØµØ© Ù„Ù„Ø¯Ù…Ø§Øº ÙˆØ§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¹ØµØ¨ÙŠ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ù…Ù…Ø§Ø±Ø³Ø© Ø§Ù„Ø±ÙŠØ§Ø¶Ø©. ØªÙ†Ù‚Ø³Ù… Ø¥Ù„Ù‰ Ø¨Ø³ÙŠØ·Ø© ÙˆÙ…Ø¹Ù‚Ø¯Ø©.</p>
                    <p class="mt-2"><strong>Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØµØ­ÙŠØ©:</strong> Ø§Ù„Ø­Ø¨ÙˆØ¨ Ø§Ù„ÙƒØ§Ù…Ù„Ø© (Ø§Ù„Ø´ÙˆÙØ§Ù†ØŒ Ø§Ù„Ø£Ø±Ø² Ø§Ù„Ø¨Ù†ÙŠ)ØŒ Ø§Ù„ÙÙˆØ§ÙƒÙ‡ØŒ Ø§Ù„Ø®Ø¶Ø±ÙˆØ§Øª Ø§Ù„Ù†Ø´ÙˆÙŠØ© (Ø§Ù„Ø¨Ø·Ø§Ø·Ø§ØŒ Ø§Ù„Ø°Ø±Ø©)ØŒ ÙˆØ§Ù„Ø¨Ù‚ÙˆÙ„ÙŠØ§Øª (Ø§Ù„Ø¹Ø¯Ø³ØŒ Ø§Ù„Ø­Ù…Øµ).</p>
                </div>
                 <div id="protein-details" class="details-panel mt-8 bg-red-50 p-6 rounded-lg border border-red-200">
                    <h4 class="text-2xl font-bold text-red-600">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†Ø§Øª</h4>
                    <p class="mt-2"><strong>Ø§Ù„ÙˆØ¸ÙŠÙØ©:</strong> ØªØªÙƒÙˆÙ† Ù…Ù† Ø£Ø­Ù…Ø§Ø¶ Ø£Ù…ÙŠÙ†ÙŠØ©ØŒ ÙˆÙ‡ÙŠ Ø¶Ø±ÙˆØ±ÙŠØ© Ù„Ù†Ù…Ùˆ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ØŒ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ù†Ø§Ø¹Ø©ØŒ ÙˆØ¥Ù†ØªØ§Ø¬ Ø§Ù„Ø¥Ù†Ø²ÙŠÙ…Ø§Øª ÙˆØ§Ù„Ù‡Ø±Ù…ÙˆÙ†Ø§Øª.</p>
                    <p class="mt-2"><strong>Ø§Ù„Ù…ØµØ§Ø¯Ø±:</strong> Ø§Ù„Ù„Ø­ÙˆÙ… Ø§Ù„Ø®Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø¯Ù‡ÙˆÙ†ØŒ Ø§Ù„Ø¯ÙˆØ§Ø¬Ù†ØŒ Ø§Ù„Ø£Ø³Ù…Ø§ÙƒØŒ Ø§Ù„Ø¨ÙŠØ¶ØŒ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£Ù„Ø¨Ø§Ù†ØŒ Ø§Ù„Ø¨Ù‚ÙˆÙ„ÙŠØ§ØªØŒ Ø§Ù„Ù…ÙƒØ³Ø±Ø§ØªØŒ ÙˆØ¨Ø°ÙˆØ± Ø§Ù„ÙƒÙŠÙ†ÙˆØ§.</p>
                </div>
                <div id="fat-details" class="details-panel mt-8 bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                    <h4 class="text-2xl font-bold text-yellow-600">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ù‡ÙˆÙ†</h4>
                    <p class="mt-2"><strong>Ø§Ù„ÙˆØ¸ÙŠÙØ©:</strong> Ù…ØµØ¯Ø± Ø·Ø§Ù‚Ø© Ù…Ø±ÙƒØ²ØŒ ØªØ³Ø§Ø¹Ø¯ ÙÙŠ Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ØŒ ÙˆØªØ¯Ø¹Ù… Ø§Ù…ØªØµØ§Øµ Ø§Ù„ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª Ø§Ù„Ø°Ø§Ø¦Ø¨Ø© ÙÙŠ Ø§Ù„Ø¯Ù‡ÙˆÙ† (A, D, E, K).</p>
                    <p class="mt-2"><strong>Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„ØµØ­ÙŠØ©:</strong> Ø§Ù„Ø£ÙÙˆÙƒØ§Ø¯ÙˆØŒ Ø²ÙŠØª Ø§Ù„Ø²ÙŠØªÙˆÙ†ØŒ Ø§Ù„Ù…ÙƒØ³Ø±Ø§Øª (Ø§Ù„Ù„ÙˆØ²ØŒ Ø§Ù„Ø¬ÙˆØ²)ØŒ Ø§Ù„Ø¨Ø°ÙˆØ± (Ø§Ù„Ø´ÙŠØ§ØŒ Ø§Ù„ÙƒØªØ§Ù†)ØŒ ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ùƒ Ø§Ù„Ø¯Ù‡Ù†ÙŠØ© (Ø§Ù„Ø³Ù„Ù…ÙˆÙ†).</p>
                </div>
                
                <div class="mt-12 bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-400">
                    <h2 class="text-2xl font-bold mb-4 text-center text-emerald-600">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©</h2>
                    <p class="text-center text-gray-600 mb-6">ØªØµÙØ­ Ø§Ù„Ø®Ø·Ø· Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„ØªÙŠ Ø´Ø§Ø±ÙƒÙ‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†.</p>
                    <div id="shared-plans-list" class="space-y-4">
                        <!-- Skeleton Loader -->
                        <div id="shared-plans-loader" class="space-y-4">
                            <div class="bg-gray-200 p-4 rounded-lg animate-pulse">
                                <div class="h-4 bg-gray-300 rounded w-3/4 mb-2"></div>
                                <div class="h-3 bg-gray-300 rounded w-1/2"></div>
                            </div>
                            <div class="bg-gray-200 p-4 rounded-lg animate-pulse">
                                <div class="h-4 bg-gray-300 rounded w-2/3 mb-2"></div>
                                <div class="h-3 bg-gray-300 rounded w-1/3"></div>
                            </div>
                        </div>
                        <!-- Shared plans will be displayed here -->
                        <div id="no-shared-plans" class="text-center text-gray-500 italic hidden">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø· ØºØ°Ø§Ø¦ÙŠØ© Ù…Ø´ØªØ±ÙƒØ© Ø¨Ø¹Ø¯. ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ´Ø§Ø±Ùƒ!</div>
                    </div>
                </div>

                <div class="mt-12 bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-400">
                    <h2 class="text-2xl font-bold mb-4 text-center text-emerald-600">Ø­Ø§Ø³Ø¨Ø© Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
                    <p class="text-center text-gray-600 mb-6">Ø£Ø¯Ø®Ù„ Ø¹Ù…Ø±Ùƒ ÙˆÙˆØ²Ù†Ùƒ ÙˆØ¬Ù†Ø³Ùƒ Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù…Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©.</p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
                        <div class="w-full sm:w-1/3">
                            <label for="age-input" class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø¹Ù…Ø± (Ø³Ù†ÙˆØ§Øª)</label>
                            <input type="number" id="age-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" placeholder="Ù…Ø«Ø§Ù„: 30" min="1" max="100">
                        </div>
                        <div class="w-full sm:w-1/3">
                            <label for="weight-input" class="block text-gray-700 font-semibold mb-2">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label>
                            <input type="number" id="weight-input" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300" placeholder="Ù…Ø«Ø§Ù„: 70" min="1" max="500">
                        </div>
                        <div class="w-full sm:w-1/3">
                            <label for="gender-select" class="block text-gray-700 font-semibold mb-2">Ø§Ù„Ø¬Ù†Ø³</label>
                            <select id="gender-select" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300">
                                <option value="male">Ø°ÙƒØ±</option>
                                <option value="female">Ø£Ù†Ø«Ù‰</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 text-center flex flex-col sm:flex-row justify-center items-center gap-4">
                        <button onclick="calculateNeeds()" class="bg-emerald-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-emerald-600 transition w-full sm:w-auto">Ø§Ø­Ø³Ø¨ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙŠ</button>
                        <button id="save-needs-btn" onclick="saveMyNeeds()" class="bg-blue-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-600 transition w-full sm:w-auto hidden">Ø­ÙØ¸ ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙŠ</button>
                    </div>
                    <div id="results-panel" class="mt-8 p-6 bg-slate-100 rounded-lg shadow-inner hidden">
                        <h4 class="text-xl font-bold text-gray-800 mb-4">Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„Ù…Ù‚Ø¯Ø±Ø©:</h4>
                        <p class="text-sm text-gray-600 mb-4">Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ÙÙŠØªØ§Ù…ÙŠÙ† Ø¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ù…ØªØµØ§Øµ Ø¬Ø³Ù…Ùƒ Ù„Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ… Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.</p>
                        <ul class="space-y-3">
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-gray-700">Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©:</span> <span id="calories-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-blue-500">Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª:</span> <span id="carb-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-red-500">Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†Ø§Øª:</span> <span id="protein-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-yellow-500">Ø§Ù„Ø¯Ù‡ÙˆÙ†:</span> <span id="fat-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-purple-500">Ø§Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ…:</span> <span id="calcium-result" class="font-semibold text-gray-800"></span></li>
                            <li class="flex justify-between items-center text-lg"><span class="font-bold text-orange-500">ÙÙŠØªØ§Ù…ÙŠÙ† Ø¯:</span> <span id="vitamin-d-result" class="font-semibold text-gray-800"></span></li>
                        </ul>
                        <div id="analysis-panel" class="mt-6 pt-4 border-t border-gray-300">
                             <h4 class="text-xl font-bold text-gray-800 mb-3">ØªØ­Ù„ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ:</h4>
                             <p id="analysis-text" class="text-gray-700"></p>
                        </div>
                    </div>

                    <div id="custom-plan-builder" class="mt-12 bg-white p-6 rounded-xl shadow-lg border-t-4 border-emerald-400 hidden">
                        <h2 class="text-2xl font-bold mb-4 text-center text-emerald-600">Ø§ØµÙ†Ø¹ Ù†Ø¸Ø§Ù…Ùƒ Ø§Ù„ØºØ°Ø§Ø¦ÙŠ Ø§Ù„Ø®Ø§Øµ</h2>
                        <p class="text-center text-gray-600 mb-6">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ø®Ø·ØªÙƒ Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.</p>
                        <div class="flex flex-col md:flex-row gap-6">
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·Ø¹Ù…Ø©</h3>
                                <div class="mb-4">
                                    <input type="text" id="food-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø¹Ø§Ù…..." class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-300">
                                </div>
                                <div id="food-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 p-4 border border-gray-200 rounded-lg max-h-80 overflow-y-auto">
                                    <!-- Food items will be dynamically generated here -->
                                </div>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-3 text-center">Ø®Ø·ØªÙŠ Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©</h3>
                                <div class="bg-slate-100 rounded-lg p-4 shadow-inner min-h-[10rem] max-h-80 overflow-y-auto">
                                    <ul id="my-plan-list" class="space-y-3">
                                        <!-- Selected food items will be listed here -->
                                    </ul>
                                </div>
                                <div class="mt-4 p-4 bg-emerald-100 rounded-lg border-t-4 border-emerald-400">
                                     <h4 class="font-bold text-lg text-emerald-700 mb-2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</h4>
                                     <ul class="text-gray-700 space-y-1">
                                         <li class="flex justify-between"><span>Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©:</span> <span id="total-calories-my-plan" class="font-semibold">0</span></li>
                                         <li class="flex justify-between"><span>Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†Ø§Øª:</span> <span id="total-protein-my-plan" class="font-semibold">0 Ø¬Ø±Ø§Ù…</span></li>
                                         <li class="flex justify-between"><span>Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª:</span> <span id="total-carbs-my-plan" class="font-semibold">0 Ø¬Ø±Ø§Ù…</span></li>
                                         <li class="flex justify-between"><span>Ø§Ù„Ø¯Ù‡ÙˆÙ†:</span> <span id="total-fats-my-plan" class="font-semibold">0 Ø¬Ø±Ø§Ù…</span></li>
                                         <li class="flex justify-between"><span>Ø§Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ…:</span> <span id="total-calcium-my-plan" class="font-semibold">0 Ù…Ù„Ø¬Ù…</span></li>
                                     </ul>
                                </div>
                                <div class="mt-4 flex flex-col gap-2">
                                     <button id="generate-plan-btn" onclick="generateMealPlan()" class="bg-purple-500 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-purple-600 transition flex items-center justify-center">
                                         <span class="mr-2">âœ¨</span>
                                         <span>ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø© ØºØ°Ø§Ø¦ÙŠØ©</span>
                                         <div id="plan-loader" class="loader ml-2 hidden"></div>
                                     </button>
                                     <button id="generate-recipes-btn" onclick="generateRecipes()" class="bg-cyan-500 text-white font-bold py-3 px-4 rounded-full shadow-lg hover:bg-cyan-600 transition flex items-center justify-center">
                                         <span class="mr-2">âœ¨</span>
                                         <span>ØªÙˆÙ„ÙŠØ¯ ÙˆØµÙØ§Øª</span>
                                         <div id="recipes-loader" class="loader ml-2 hidden"></div>
                                     </button>
                                </div>
                            </div>
                        </div>
                         <div id="ai-output" class="mt-8 p-6 bg-slate-100 rounded-lg shadow-inner hidden">
                            <h4 class="text-xl font-bold text-gray-800 mb-3" id="ai-output-title"></h4>
                            <div id="ai-output-content" class="text-gray-700 space-y-4"></div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section id="micro-section" style="display: none;">
                <div class="text-center mb-12">
                     <h2 class="text-3xl font-bold text-gray-800">Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„ØµØºØ±Ù‰ØŸ</h2>
                     <p class="mt-3 max-w-3xl mx-auto text-gray-600">Ù‡ÙŠ Ø§Ù„ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù† Ø§Ù„ØªÙŠ ÙŠØ­ØªØ§Ø¬Ù‡Ø§ Ø§Ù„Ø¬Ø³Ù… Ø¨ÙƒÙ…ÙŠØ§Øª Ø£Ù‚Ù„ØŒ ÙˆÙ„ÙƒÙ†Ù‡Ø§ Ø­ÙŠÙˆÙŠØ© Ù„Ù„ØºØ§ÙŠØ© Ù„Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙØ³ÙŠÙˆÙ„ÙˆØ¬ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©ØŒ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„Ù…Ù†Ø§Ø¹Ø© Ø¥Ù„Ù‰ ØµØ­Ø© Ø§Ù„Ø¹Ø¸Ø§Ù…. Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ ÙƒÙ„ ÙØ¦Ø© Ù„Ø§Ø³ØªÙƒØ´Ø§ÙÙ‡Ø§.</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div id="vitamins-container" class="bg-white p-6 rounded-xl shadow-lg">
                         <h3 class="text-2xl font-bold mb-4 text-center text-emerald-600">Ø§Ù„ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª</h3>
                         <div class="space-y-3" id="vitamins-list"></div>
                    </div>
                    <div id="minerals-container" class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-2xl font-bold mb-4 text-center text-emerald-600">Ø§Ù„Ù…Ø¹Ø§Ø¯Ù†</h3>
                        <div class="space-y-3" id="minerals-list"></div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-16 pt-8 border-t border-gray-200">
            <p class="text-gray-500">ØªÙ… ØªØµÙ…ÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ø¯Ù„ÙŠÙ„ Ù„ØªÙˆÙÙŠØ± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø©. Ø§Ø³ØªØ´Ø± Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø£Ø®ØµØ§Ø¦ÙŠ ØªØºØ°ÙŠØ© Ø£Ùˆ Ø·Ø¨ÙŠØ¨Ù‹Ø§ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØµØ§Ø¦Ø­ Ø´Ø®ØµÙŠØ©.</p>
            <p id="user-id-display" class="mt-2 text-xs text-gray-400">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: </p>
        </footer>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, query, where, updateDoc, getDocs, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Firestore Debugging
    setLogLevel('debug');

    // Global Firebase variables
    let app, auth, db, userId;
    let isFirebaseReady = false;

    // Firebase configuration from the environment
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // A global variable to hold the nutrition plan.
    let myPlan = [];
    const MY_PLAN_DOC_ID = 'my-plan-doc';
    
    let sharedPlansList, noSharedPlansDiv, sharedPlansLoader;

    // Initialize Firebase
    if (Object.keys(firebaseConfig).length > 0) {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Firebase Authenticated. User ID:", userId);
                document.getElementById('user-id-display').textContent = `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${userId}`;
                isFirebaseReady = true;
                await initializeCollaboration();
            } else {
                console.log("Firebase Auth State Changed. Signing in.");
                try {
                     if (initialAuthToken) {
                         await signInWithCustomToken(auth, initialAuthToken);
                     } else {
                         await signInAnonymously(auth);
                     }
                } catch (error) {
                    console.error("Error during authentication:", error);
                }
            }
        });
    } else {
        console.error("Firebase config is missing. Collaboration features will not work.");
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        sharedPlansList = document.getElementById('shared-plans-list');
        noSharedPlansDiv = document.getElementById('no-shared-plans');
        sharedPlansLoader = document.getElementById('shared-plans-loader');
        
        document.getElementById('food-search').addEventListener('keyup', handleSearch);

        showSection('macro');
        renderFoodList(foodDatabase);
    });

    async function initializeCollaboration() {
        if (!isFirebaseReady) {
            console.error("Firebase is not ready yet.");
            return;
        }

        // Listen for real-time updates to all shared plans
        const sharedPlansCollection = collection(db, 'artifacts', appId, 'public', 'data', 'nutrition_plans');
        onSnapshot(sharedPlansCollection, (querySnapshot) => {
            const sharedPlans = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const id = doc.id;
                if (data.type === 'meal_plan' && typeof data.plan === 'string') {
                    try {
                        data.plan = JSON.parse(data.plan);
                        sharedPlans.push({ id, ...data });
                    } catch (e) {
                        console.error("Failed to parse shared meal plan data from Firestore:", e);
                    }
                } else {
                    sharedPlans.push({ id, ...data });
                }
            });
            renderSharedPlans(sharedPlans);
        }, (error) => {
            console.error("Error getting real-time updates for shared plans:", error);
            if(sharedPlansLoader) sharedPlansLoader.style.display = 'none';
        });

        // Listen for real-time updates to my personal plan
        const myPlanDocRef = doc(db, 'artifacts', appId, 'users', userId, 'my_nutrition_plan', MY_PLAN_DOC_ID);
        onSnapshot(myPlanDocRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                if (data.plan && typeof data.plan === 'string') {
                    try {
                        myPlan = JSON.parse(data.plan);
                        updatePlanDisplay();
                    } catch (e) {
                        console.error("Failed to parse my plan data from Firestore:", e);
                    }
                }
            } else {
                console.log("No personal plan found, starting with an empty one.");
                myPlan = [];
                updatePlanDisplay();
            }
        }, (error) => {
            console.error("Error getting real-time updates for my plan:", error);
        });
    }

    async function saveMyPlanToFirestore() {
        if (!isFirebaseReady) {
            console.error("Firebase is not ready, cannot save data.");
            return;
        }
        try {
            const myPlanDocRef = doc(db, 'artifacts', appId, 'users', userId, 'my_nutrition_plan', MY_PLAN_DOC_ID);
            const serializedPlan = JSON.stringify(myPlan);
            await setDoc(myPlanDocRef, {
                plan: serializedPlan,
                lastUpdated: new Date()
            }, { merge: true });
            console.log("My plan saved successfully!");
        } catch (e) {
            console.error("Error adding my plan document: ", e);
        }
    }

    async function saveSharedPlanToFirestore() {
        if (!isFirebaseReady) {
            console.error("Firebase is not ready, cannot save data.");
            return;
        }
        try {
            const sharedPlansCollection = collection(db, 'artifacts', appId, 'public', 'data', 'nutrition_plans');
            const serializedPlan = JSON.stringify(myPlan);
            await addDoc(sharedPlansCollection, {
                userId: userId,
                plan: serializedPlan,
                totalCalories: calculateTotalCalories(myPlan),
                type: 'meal_plan',
                lastUpdated: new Date()
            });
            showToast("ØªÙ…Øª Ù…Ø´Ø§Ø±ÙƒØ© Ø®Ø·ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!");
            console.log("Shared plan saved successfully!");
        } catch (e) {
            console.error("Error adding shared plan document: ", e);
            showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø®Ø·Ø©.", 'error');
        }
    }

    window.saveMyNeeds = async function() {
        if (!isFirebaseReady) {
            showToast("Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.", 'error');
            return;
        }
        
        const age = parseInt(document.getElementById('age-input').value);
        const weight = parseInt(document.getElementById('weight-input').value);
        const gender = document.getElementById('gender-select').value;
        const totalCalories = document.getElementById('calories-result').textContent;
        const totalProtein = document.getElementById('protein-result').textContent;
        const totalCarbs = document.getElementById('carb-result').textContent;
        const totalFats = document.getElementById('fat-result').textContent;

        if (isNaN(age) || isNaN(weight) || age <= 0 || weight <= 0) {
            showToast("ÙŠØ±Ø¬Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹.", 'error');
            return;
        }
        
        try {
            const sharedPlansCollection = collection(db, 'artifacts', appId, 'public', 'data', 'nutrition_plans');
            await addDoc(sharedPlansCollection, {
                userId: userId,
                age: age,
                weight: weight,
                gender: gender,
                calories: totalCalories,
                protein: totalProtein,
                carbs: totalCarbs,
                fats: totalFats,
                type: 'calculated_needs',
                lastUpdated: new Date()
            });
            showToast("ØªÙ… Ø­ÙØ¸ ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!");
            console.log("Calculated needs saved successfully!");
        } catch (e) {
            console.error("Error saving calculated needs: ", e);
            showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.", 'error');
        }
    }
    
    window.deletePlan = async function(planId) {
        if (!isFirebaseReady) {
            showToast("Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.", 'error');
            return;
        }
        try {
            const planDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'nutrition_plans', planId);
            await deleteDoc(planDocRef);
            showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø·Ø© Ø¨Ù†Ø¬Ø§Ø­.");
            console.log(`Plan ${planId} deleted successfully!`);
        } catch (e) {
            console.error("Error deleting plan document: ", e);
            showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø®Ø·Ø©.", 'error');
        }
    }
    
    function renderSharedPlans(plans) {
        if (!sharedPlansList || !noSharedPlansDiv || !sharedPlansLoader) {
            return;
        }
        
        sharedPlansLoader.style.display = 'none';
        sharedPlansList.innerHTML = '';
        
        if (plans.length === 0) {
            noSharedPlansDiv.classList.remove('hidden');
            sharedPlansList.appendChild(noSharedPlansDiv);
            return;
        } 
        
        noSharedPlansDiv.classList.add('hidden');

        plans.forEach((planData) => {
            const planBox = document.createElement('div');
            const isOwner = planData.userId === userId;
            const deleteButtonHTML = isOwner ? `<button class="delete-btn" onclick="deletePlan('${planData.id}')" title="Ø­Ø°Ù">&times;</button>` : '';
            
            if (planData.type === 'calculated_needs') {
                planBox.className = 'shared-needs-box bg-blue-100 p-4 rounded-lg shadow-sm border-t-2 border-blue-300';
                planBox.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <span class="font-bold text-gray-700">Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ù…Ù‚Ø¯Ø±Ø© Ù…Ù†: <span class="font-mono text-xs text-gray-500">${planData.userId}</span></span>
                            <div class="text-sm text-gray-600 mt-1">Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©: ${planData.calories}</div>
                        </div>
                        ${deleteButtonHTML}
                    </div>
                    <div class="mt-4 text-sm text-gray-700 space-y-1">
                        <p><strong>Ø§Ù„Ø¹Ù…Ø±:</strong> ${planData.age} Ø³Ù†Ø©ØŒ <strong>Ø§Ù„ÙˆØ²Ù†:</strong> ${planData.weight} ÙƒØ¬Ù…</p>
                        <p><strong>Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†:</strong> ${planData.protein}ØŒ <strong>Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª:</strong> ${planData.carbs}ØŒ <strong>Ø§Ù„Ø¯Ù‡ÙˆÙ†:</strong> ${planData.fats}</p>
                    </div>
                `;
            } else { // Assumed to be 'meal_plan'
                planBox.className = 'shared-plan-box bg-slate-100 p-4 rounded-lg shadow-sm border-t-2 border-slate-300';
                planBox.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1 cursor-pointer" onclick="toggleSharedPlanDetails('plan-details-${planData.id}')">
                            <span class="font-bold text-gray-700">Ø®Ø·Ø© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span class="font-mono text-xs text-gray-500">${planData.userId}</span></span>
                            <div class="text-sm text-gray-600 mt-1">Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©: ${planData.totalCalories}</div>
                        </div>
                        <div class="flex items-center gap-4">
                            ${deleteButtonHTML}
                            <span class="text-xl text-gray-500 transform transition-transform duration-300 rotate-0 cursor-pointer" onclick="toggleSharedPlanDetails('plan-details-${planData.id}')" id="arrow-${planData.id}">+</span>
                        </div>
                    </div>
                    <div id="plan-details-${planData.id}" class="plan-details mt-4">
                        <ul class="space-y-2 text-sm text-gray-700">
                        </ul>
                    </div>
                `;
                const detailsList = planBox.querySelector('ul');
                if (detailsList && Array.isArray(planData.plan)) {
                    planData.plan.forEach(foodItem => {
                        const item = document.createElement('li');
                        item.className = 'flex justify-between items-center bg-white p-2 rounded';
                        item.innerHTML = `
                            <span>${foodItem.name}</span>
                            <span class="font-semibold text-gray-600">${foodItem.quantity} ÙˆØ­Ø¯Ø©</span>
                        `;
                        detailsList.appendChild(item);
                    });
                }
            }
            sharedPlansList.appendChild(planBox);
        });
    }
    
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        if (!toast) return;
        toast.textContent = message;
        toast.className = `toast show ${type}`;
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    window.toggleSharedPlanDetails = function(id) {
        const details = document.getElementById(id);
        const arrowId = `arrow-${id.split('-')[2]}`;
        const arrow = document.getElementById(arrowId);
        
        if (!details) return;
        
        if (details.classList.contains('active')) {
            details.classList.remove('active');
            if (arrow) arrow.style.transform = 'rotate(0deg)';
        } else {
            details.classList.add('active');
            if (arrow) arrow.style.transform = 'rotate(45deg)';
        }
    }

    // --- Existing JavaScript from previous version, updated for Firebase ---
    
    const macroChartCtx = document.getElementById('macroChart').getContext('2d');
    const macroChart = new Chart(macroChartCtx, {
        type: 'doughnut',
        data: {
            labels: ['Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª', 'Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†Ø§Øª', 'Ø§Ù„Ø¯Ù‡ÙˆÙ†'],
            datasets: [{
                label: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„Ø­Ø±Ø§Ø±ÙŠØ©',
                data: [50, 20, 30],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.7)',
                    'rgba(248, 113, 113, 0.7)',
                    'rgba(251, 191, 36, 0.7)'
                ],
                borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(248, 113, 113, 1)',
                    'rgba(251, 191, 36, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            family: 'Cairo',
                            size: 14
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += context.parsed + '% Ù…Ù† Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©';
                            }
                            return label;
                        }
                    },
                    bodyFont: {
                        family: 'Cairo'
                    },
                    titleFont: {
                        family: 'Cairo'
                    }
                }
            }
        }
    });

    let activeDetailsPanel = null;
    
    window.toggleDetails = function(panelId) {
        const panel = document.getElementById(panelId);
        
        if(activeDetailsPanel && activeDetailsPanel !== panel) {
            activeDetailsPanel.classList.remove('active');
        }

        panel.classList.toggle('active');

        if (panel.classList.contains('active')) {
            activeDetailsPanel = panel;
        } else {
            activeDetailsPanel = null;
        }
    }

    window.showSection = function(section) {
        const macroSection = document.getElementById('macro-section');
        const microSection = document.getElementById('micro-section');
        const macroTab = document.getElementById('macro-tab');
        const microTab = document.getElementById('micro-tab');

        if (macroSection) macroSection.style.display = (section === 'macro' ? 'block' : 'none');
        if (microSection) microSection.style.display = (section === 'micro' ? 'block' : 'none');
        if (macroTab) macroTab.classList.toggle('active', section === 'macro');
        if (microTab) microTab.classList.toggle('active', section === 'micro');
    }
    
    const micronutrients = {
        vitamins: [
            { name: "ÙÙŠØªØ§Ù…ÙŠÙ† Ø£", description: "Ø¶Ø±ÙˆØ±ÙŠ Ù„Ù„Ø±Ø¤ÙŠØ©ØŒ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ù†Ø§Ø¹Ø©ØŒ ÙˆØµØ­Ø© Ø§Ù„Ø¬Ù„Ø¯.", sources: "Ø§Ù„Ø¬Ø²Ø±ØŒ Ø§Ù„Ø¨Ø·Ø§Ø·Ø§ Ø§Ù„Ø­Ù„ÙˆØ©ØŒ Ø§Ù„Ø³Ø¨Ø§Ù†Ø®." },
            { name: "ÙÙŠØªØ§Ù…ÙŠÙ† Ø¯", description: "ÙŠØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø§Ù…ØªØµØ§Øµ Ø§Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ… Ù„ØµØ­Ø© Ø§Ù„Ø¹Ø¸Ø§Ù….", sources: "Ø£Ø´Ø¹Ø© Ø§Ù„Ø´Ù…Ø³ØŒ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ Ø§Ù„Ø¯Ù‡Ù†ÙŠØ©ØŒ Ø§Ù„Ø­Ù„ÙŠØ¨ Ø§Ù„Ù…Ø¯Ø¹Ù…." },
            { name: "ÙÙŠØªØ§Ù…ÙŠÙ† Ù‡Ù€", description: "Ù…Ø¶Ø§Ø¯ Ù„Ù„Ø£ÙƒØ³Ø¯Ø© ÙŠØ­Ù…ÙŠ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ù…Ù† Ø§Ù„ØªÙ„Ù.", sources: "Ø§Ù„Ù…ÙƒØ³Ø±Ø§ØªØŒ Ø§Ù„Ø¨Ø°ÙˆØ±ØŒ Ø²ÙŠØª Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø´Ù…Ø³." },
            { name: "ÙÙŠØªØ§Ù…ÙŠÙ† Ùƒ", description: "Ù…Ù‡Ù… Ù„ØªØ®Ø«Ø± Ø§Ù„Ø¯Ù… ÙˆØµØ­Ø© Ø§Ù„Ø¹Ø¸Ø§Ù….", sources: "Ø§Ù„Ø®Ø¶Ø±ÙˆØ§Øª Ø§Ù„ÙˆØ±Ù‚ÙŠØ© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ (Ø§Ù„ÙƒØ±Ù†Ø¨ØŒ Ø§Ù„Ø³Ø¨Ø§Ù†Ø®)." },
            { name: "ÙÙŠØªØ§Ù…ÙŠÙ† Ø¬", description: "ÙŠØ¹Ø²Ø² Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ù†Ø§Ø¹Ø© ÙˆÙŠØ³Ø§Ø¹Ø¯ ÙÙŠ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ÙƒÙˆÙ„Ø§Ø¬ÙŠÙ†.", sources: "Ø§Ù„Ø­Ù…Ø¶ÙŠØ§Øª (Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„)ØŒ Ø§Ù„ÙØ±Ø§ÙˆÙ„Ø©ØŒ Ø§Ù„ÙÙ„ÙÙ„." },
            { name: "ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª Ø¨", description: "Ù…Ø¬Ù…ÙˆØ¹Ø© ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª ØªØ³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ø³ØªÙ‚Ù„Ø§Ø¨ Ø§Ù„Ø·Ø§Ù‚Ø© ÙˆÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¯Ù…Ø§Øº.", sources: "Ø§Ù„Ø­Ø¨ÙˆØ¨ Ø§Ù„ÙƒØ§Ù…Ù„Ø©ØŒ Ø§Ù„Ù„Ø­ÙˆÙ…ØŒ Ø§Ù„Ø¨ÙŠØ¶ØŒ Ø§Ù„Ø¨Ù‚ÙˆÙ„ÙŠØ§Øª." }
        ],
        minerals: [
            { name: "Ø§Ù„ÙƒØ§Ù„Ø³ÙŠÙˆÙ…", description: "Ø£Ø³Ø§Ø³ÙŠ Ù„Ø¨Ù†Ø§Ø¡ Ø¹Ø¸Ø§Ù… ÙˆØ£Ø³Ù†Ø§Ù† Ù‚ÙˆÙŠØ©.", sources: "Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£Ù„Ø¨Ø§Ù†ØŒ Ø§Ù„Ø¨Ø±ÙˆÙƒÙ„ÙŠØŒ Ø§Ù„Ù„ÙˆØ²." },
            { name: "Ø§Ù„Ø­Ø¯ÙŠØ¯", description: "ÙŠÙ†Ù‚Ù„ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† ÙÙŠ Ø§Ù„Ø¯Ù… ÙˆÙŠÙ…Ù†Ø¹ ÙÙ‚Ø± Ø§Ù„Ø¯Ù….", sources: "Ø§Ù„Ù„Ø­ÙˆÙ… Ø§Ù„Ø­Ù…Ø±Ø§Ø¡ØŒ Ø§Ù„Ø³Ø¨Ø§Ù†Ø®ØŒ Ø§Ù„Ø¹Ø¯Ø³." },
            { name: "Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…", description: "ÙŠÙ†Ø¸Ù… ØªÙˆØ§Ø²Ù† Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ ÙˆØ¶ØºØ· Ø§Ù„Ø¯Ù….", sources: "Ø§Ù„Ù…ÙˆØ²ØŒ Ø§Ù„Ø¨Ø·Ø§Ø·Ø§ØŒ Ø§Ù„Ø£ÙÙˆÙƒØ§Ø¯Ùˆ." },
            { name: "Ø§Ù„Ù…ØºÙ†ÙŠØ³ÙŠÙˆÙ…", description: "ÙŠØ´Ø§Ø±Ùƒ ÙÙŠ Ø£ÙƒØ«Ø± Ù…Ù† 300 ØªÙØ§Ø¹Ù„ Ø¥Ù†Ø²ÙŠÙ…ÙŠ ÙÙŠ Ø§Ù„Ø¬Ø³Ù….", sources: "Ø§Ù„Ù…ÙƒØ³Ø±Ø§ØªØŒ Ø§Ù„Ø¨Ø°ÙˆØ±ØŒ Ø§Ù„Ø´ÙˆÙƒÙˆÙ„Ø§ØªØ© Ø§Ù„Ø¯Ø§ÙƒÙ†Ø©." },
            { name: "Ø§Ù„Ø²Ù†Ùƒ", description: "ÙŠØ¯Ø¹Ù… ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ù†Ø§Ø¹Ø© ÙˆØ§Ù„ØªØ¦Ø§Ù… Ø§Ù„Ø¬Ø±ÙˆØ­.", sources: "Ø§Ù„Ù„Ø­ÙˆÙ…ØŒ Ø§Ù„Ù…Ø­Ø§Ø±ØŒ Ø¨Ø°ÙˆØ± Ø§Ù„ÙŠÙ‚Ø·ÙŠÙ†." },
            { name: "Ø§Ù„ÙŠÙˆØ¯", description: "Ø¶Ø±ÙˆØ±ÙŠ Ù„ÙˆØ¸ÙŠÙØ© Ø§Ù„ØºØ¯Ø© Ø§Ù„Ø¯Ø±Ù‚ÙŠØ© Ø§Ù„ØµØ­ÙŠØ©.", sources: "Ù…Ù„Ø­ Ø§Ù„Ø·Ø¹Ø§Ù… Ø§Ù„Ù…Ø¯Ø¹Ù… Ø¨Ø§Ù„ÙŠÙˆØ¯ØŒ Ø§Ù„Ø£Ø¹Ø´Ø§Ø¨ Ø§Ù„Ø¨Ø­Ø±ÙŠØ©ØŒ Ø§Ù„Ø£Ø³Ù…Ø§Ùƒ." }
        ]
    };

    window.createMicroNutrientList = function(data, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = ''; // Clear previous content
        data.forEach((item) => {
            const wrapper = document.createElement('div');
            const button = document.createElement('button');
            button.className = 'w-full text-right p-3 bg-gray-100 rounded-lg font-semibold hover:bg-emerald-100 transition flex justify-between items-center';
            button.innerHTML = `<span>${item.name}</span> <span class="plus-icon text-emerald-500 font-bold text-xl">+</span>`;
            
            const details = document.createElement('div');
            details.className = 'details-panel p-4 bg-white border-l-4 border-emerald-200';
            details.innerHTML = `
                <p><strong>Ø§Ù„ÙˆØ¸ÙŠÙØ©:</strong> ${item.description}</p>
                <p class="mt-2"><strong>Ø£Ø¨Ø±Ø² Ø§Ù„Ù…ØµØ§Ø¯Ø±:</strong> ${item.sources}</p>
            `;

            button.onclick = () => {
                const isActive = details.classList.contains('active');
                
                document.querySelectorAll(`#${containerId} .details-panel`).forEach(p => p.classList.remove('active'));
                document.querySelectorAll(`#${containerId} .plus-icon`).forEach(icon => icon.textContent = '+');

                if (!isActive) {
                    details.classList.add('active');
                    button.querySelector('.plus-icon').textContent = '-';
                }
            };
            
            wrapper.appendChild(button);
            wrapper.appendChild(details);
            container.appendChild(wrapper);
        });
    }

    createMicroNutrientList(micronutrients.vitamins, 'vitamins-list');
    createMicroNutrientList(micronutrients.minerals, 'minerals-list');
    
    // Food data with improved image placeholders
    const foodDatabase = [
        { name: 'ØµØ¯Ø± Ø¯Ø¬Ø§Ø¬ (100Ø¬)', calories: 165, protein: 31, carbs: 0, fats: 3.6, calcium: 10, image: { emoji: 'ğŸ”', color: 'f59e0b' } },
        { name: 'Ø¨ÙŠØ¶ Ù…Ø³Ù„ÙˆÙ‚ (1 Ø¨ÙŠØ¶Ø© ÙƒØ¨ÙŠØ±Ø©)', calories: 78, protein: 6.3, carbs: 0.6, fats: 5.3, calcium: 25, image: { emoji: 'ğŸ¥š', color: 'fef3c7' } },
        { name: 'Ø£Ø±Ø² Ø£Ø¨ÙŠØ¶ Ù…Ø·Ø¨ÙˆØ® (100Ø¬)', calories: 130, protein: 2.7, carbs: 28, fats: 0.3, calcium: 15, image: { emoji: 'ğŸš', color: 'e5e7eb' } },
        { name: 'Ø®Ø¨Ø² Ù‚Ù…Ø­ ÙƒØ§Ù…Ù„ (Ø´Ø±ÙŠØ­Ø©)', calories: 82, protein: 4, carbs: 14.8, fats: 1.1, calcium: 30, image: { emoji: 'ğŸ', color: 'd97706' } },
        { name: 'Ø¹Ø¯Ø³ Ù…Ø·Ø¨ÙˆØ® (100Ø¬)', calories: 116, protein: 9, carbs: 20, fats: 0.4, calcium: 19, image: { emoji: 'ğŸ¥£', color: 'ca8a04' } },
        { name: 'Ø³Ø¨Ø§Ù†Ø® (100Ø¬)', calories: 23, protein: 2.9, carbs: 3.6, fats: 0.4, calcium: 99, image: { emoji: 'ğŸŒ¿', color: '16a34a' } },
        { name: 'ØªÙØ§Ø­ (100Ø¬)', calories: 52, protein: 0.3, carbs: 13.8, fats: 0.2, calcium: 6, image: { emoji: 'ğŸ', color: 'ef4444' } },
        { name: 'Ø¨Ø±ÙˆÙƒÙ„ÙŠ (100Ø¬)', calories: 34, protein: 2.8, carbs: 6.6, fats: 0.4, calcium: 47, image: { emoji: 'ğŸ¥¦', color: '22c55e' } },
        { name: 'Ø£ÙÙˆÙƒØ§Ø¯Ùˆ (100Ø¬)', calories: 160, protein: 2, carbs: 8.5, fats: 14.7, calcium: 12, image: { emoji: 'ğŸ¥‘', color: '84cc16' } },
        { name: 'Ø²ÙŠØª Ø²ÙŠØªÙˆÙ† (Ù…Ù„Ø¹Ù‚Ø© ÙƒØ¨ÙŠØ±Ø©)', calories: 119, protein: 0, carbs: 0, fats: 13.5, calcium: 0, image: { emoji: 'ğŸ«’', color: 'ca8a04' } },
        { name: 'Ù„ÙˆØ² (100Ø¬)', calories: 579, protein: 21, carbs: 21.5, fats: 49.9, calcium: 264, image: { emoji: 'ğŸŒ°', color: 'a16207' } },
        { name: 'Ø²Ø¨Ø§Ø¯ÙŠ ÙŠÙˆÙ†Ø§Ù†ÙŠ (100Ø¬)', calories: 59, protein: 10, carbs: 3.6, fats: 0.4, calcium: 101, image: { emoji: 'ğŸ¦', color: 'e0f2fe' } },
        { name: 'Ù‚Ù‡ÙˆØ© Ø³Ø§Ø¯Ø© (240 Ù…Ù„)', calories: 2, protein: 0.3, carbs: 0, fats: 0, calcium: 5, image: { emoji: 'â˜•', color: '44403c' } },
        { name: 'Ø­Ù„ÙŠØ¨ Ø¨Ù‚Ø±ÙŠ (240 Ù…Ù„)', calories: 149, protein: 8, carbs: 12, fats: 8, calcium: 300, image: { emoji: 'ğŸ¥›', color: 'f8fafc' } },
        { name: 'Ø³Ù„Ù…ÙˆÙ† Ù…Ø·Ø¨ÙˆØ® (100Ø¬)', calories: 208, protein: 20, carbs: 0, fats: 13, calcium: 10, image: { emoji: 'ğŸŸ', color: 'f97316' } },
        { name: 'Ø¨Ø·Ø§Ø·Ø§ Ø­Ù„ÙˆØ© Ù…Ø·Ø¨ÙˆØ®Ø© (100Ø¬)', calories: 76, protein: 1.5, carbs: 17.7, fats: 0.1, calcium: 30, image: { emoji: 'ğŸ ', color: 'ea580c' } },
        { name: 'Ù„Ø­Ù…Ø© (100Øº)', calories: 250, protein: 26, carbs: 0, fats: 17, calcium: 18, image: { emoji: 'ğŸ¥©', color: 'dc2626' } },
        { name: 'Ø¨Ø·Ø§Ø·Ø§ (100Øº)', calories: 77, protein: 2, carbs: 17, fats: 0.1, calcium: 12, image: { emoji: 'ğŸ¥”', color: 'facc15' } },
        { name: 'Ø³Ø±Ø¯ÙŠÙ† Ø¨Ø§Ù„Ø²ÙŠØª (100Øº)', calories: 255, protein: 22.3, carbs: 0, fats: 14.5, calcium: 24, image: { emoji: 'ğŸŸ', color: '64748b' } }
    ];

    function handleSearch(event) {
        const searchTerm = event.target.value.toLowerCase().trim();
        const filteredFoods = foodDatabase.filter(food => 
            food.name.toLowerCase().includes(searchTerm)
        );
        renderFoodList(filteredFoods);
    }
    
    function renderFoodList(foods) {
        const foodListContainer = document.getElementById('food-list');
        if (!foodListContainer) return;
        foodListContainer.innerHTML = '';
        foods.forEach(food => {
            const button = document.createElement('button');
            button.className = 'food-item-btn flex flex-col items-center justify-center p-4 bg-gray-100 rounded-xl shadow hover:bg-emerald-100 transition-colors cursor-pointer';
            
            button.innerHTML = `
                <div class="food-image" style="background-color:#${food.image.color};">${food.image.emoji}</div>
                <span class="text-sm font-semibold text-gray-800 text-center mt-2">${food.name}</span>
                <span class="text-xs text-gray-500 mt-1">${food.calories} Ø³Ø¹Ø± Ø­Ø±Ø§Ø±ÙŠ</span>
            `;
            button.onclick = () => addFoodToPlan(food);
            foodListContainer.appendChild(button);
        });
    }

    function addFoodToPlan(food) {
        const existingFood = myPlan.find(item => item.name === food.name);
        if (existingFood) {
            existingFood.quantity++;
        } else {
            myPlan.push({ ...food, quantity: 1 });
        }
        updatePlanDisplay();
        saveMyPlanToFirestore();
    }
    
    function calculateTotalCalories(plan) {
        return plan.reduce((total, item) => total + (item.calories || 0) * item.quantity, 0);
    }
    
    function updatePlanDisplay() {
        const myPlanList = document.getElementById('my-plan-list');
        if (!myPlanList) return;
        myPlanList.innerHTML = '';
        
        let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFats = 0, totalCalcium = 0;

        myPlan.forEach((item, index) => {
            totalCalories += (item.calories || 0) * item.quantity;
            totalProtein += (item.protein || 0) * item.quantity;
            totalCarbs += (item.carbs || 0) * item.quantity;
            totalFats += (item.fats || 0) * item.quantity;
            totalCalcium += (item.calcium || 0) * item.quantity;

            const listItem = document.createElement('li');
            listItem.className = 'flex justify-between items-center bg-white p-3 rounded-lg shadow-sm text-sm';
            listItem.innerHTML = `
                <div>
                    <span class="font-bold text-gray-700">${item.name}</span>
                    <span class="text-xs text-gray-500 block">
                        (${item.calories} Ø³ØŒ ${item.protein}Ø¨ØŒ ${item.carbs}ÙƒØŒ ${item.fats}Ø¯)
                    </span>
                </div>
                <div class="quantity-control">
                    <button onclick="changeQuantity(${index}, -1)" class="text-gray-600 font-bold">-</button>
                    <span class="px-2 text-gray-800">${item.quantity}</span>
                    <button onclick="changeQuantity(${index}, 1)" class="text-gray-600 font-bold">+</button>
                </div>
            `;
            myPlanList.appendChild(listItem);
        });

        document.getElementById('total-calories-my-plan').textContent = totalCalories.toFixed(0);
        document.getElementById('total-protein-my-plan').textContent = `${totalProtein.toFixed(1)} Ø¬Ø±Ø§Ù…`;
        document.getElementById('total-carbs-my-plan').textContent = `${totalCarbs.toFixed(1)} Ø¬Ø±Ø§Ù…`;
        document.getElementById('total-fats-my-plan').textContent = `${totalFats.toFixed(1)} Ø¬Ø±Ø§Ù…`;
        document.getElementById('total-calcium-my-plan').textContent = `${totalCalcium.toFixed(0)} Ù…Ù„Ø¬Ù…`;
    }

    window.changeQuantity = function(index, change) {
        if (myPlan[index].quantity + change > 0) {
            myPlan[index].quantity += change;
        } else {
            myPlan.splice(index, 1);
        }
        updatePlanDisplay();
        saveMyPlanToFirestore();
    }

    window.calculateNeeds = function() {
        const age = parseInt(document.getElementById('age-input').value);
        const weight = parseInt(document.getElementById('weight-input').value);
        const gender = document.getElementById('gender-select').value;
        const resultsPanel = document.getElementById('results-panel');
        const customPlanBuilder = document.getElementById('custom-plan-builder');
        const saveNeedsBtn = document.getElementById('save-needs-btn');
        
        if (isNaN(age) || isNaN(weight) || age <= 0 || weight <= 0) {
            showToast("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¹Ù…Ø± ÙˆØ§Ù„ÙˆØ²Ù† Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.", 'error');
            if (resultsPanel) resultsPanel.classList.add('hidden');
            if (customPlanBuilder) customPlanBuilder.classList.add('hidden');
            if (saveNeedsBtn) saveNeedsBtn.classList.add('hidden');
            return;
        }
        
        let totalCalories;
        if (gender === 'male') {
            totalCalories = weight * 30; 
        } else {
            totalCalories = weight * 25; 
        }
        
        const proteinGrams = (weight * 1.2).toFixed(1);
        const fatGrams = (totalCalories * 0.25 / 9).toFixed(1);
        const carbGrams = (totalCalories * 0.55 / 4).toFixed(1);
        
        const calciumGrams = 1000;
        const vitaminDIU = 600;

        document.getElementById('calories-result').textContent = `${totalCalories.toFixed(0)} Ø³Ø¹Ø± Ø­Ø±Ø§Ø±ÙŠ`;
        document.getElementById('protein-result').textContent = `${proteinGrams} Ø¬Ø±Ø§Ù…`;
        document.getElementById('fat-result').textContent = `${fatGrams} Ø¬Ø±Ø§Ù…`;
        document.getElementById('carb-result').textContent = `${carbGrams} Ø¬Ø±Ø§Ù…`;
        document.getElementById('calcium-result').textContent = `${calciumGrams} Ù…Ù„Ø¬Ù…`;
        document.getElementById('vitamin-d-result').textContent = `${vitaminDIU} ÙˆØ­Ø¯Ø© Ø¯ÙˆÙ„ÙŠØ© (IU)`;
        
        if (resultsPanel) resultsPanel.classList.remove('hidden');
        if (customPlanBuilder) customPlanBuilder.classList.remove('hidden');
        if (saveNeedsBtn) saveNeedsBtn.classList.remove('hidden');
        displayAnalysis(totalCalories, proteinGrams, carbGrams, fatGrams);
    }
    
    window.displayAnalysis = function(calories, protein, carbs, fats) {
        const analysisPanel = document.getElementById('analysis-panel');
        const analysisText = document.getElementById('analysis-text');
        
        if (!analysisPanel || !analysisText) return;

        let analysisContent = `
            <p> Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŒ ØªÙ‚Ø¯Ø± Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø¨Ø­ÙˆØ§Ù„ÙŠ <span class="font-bold text-emerald-600">${calories.toFixed(0)}</span> Ø³Ø¹Ø± Ø­Ø±Ø§Ø±ÙŠ. Ù‡Ø°Ø§ Ù‡Ùˆ Ù…Ù‚Ø¯Ø§Ø± Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙŠ ÙŠØ­ØªØ§Ø¬Ù‡Ø§ Ø¬Ø³Ù…Ùƒ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙˆØ¸Ø§Ø¦ÙÙ‡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆÙ†Ø´Ø§Ø·Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ.</p>
            <p class="mt-4">Ù„ØªÙ„Ø¨ÙŠØ© Ù‡Ø°Ù‡ Ø§Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªØŒ ÙŠÙÙ†ØµØ­ Ø¨ØªÙ†Ø§ÙˆÙ„:</p>
            <ul class="list-disc list-inside mt-2 space-y-2">
                <li><span class="font-bold text-blue-500">${carbs}</span> Ø¬Ø±Ø§Ù… Ù…Ù† Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§ØªØŒ Ù„ØªØ²ÙˆÙŠØ¯ Ø¬Ø³Ù…Ùƒ Ø¨Ø§Ù„ÙˆÙ‚ÙˆØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ.</li>
                <li><span class="font-bold text-red-500">${protein}</span> Ø¬Ø±Ø§Ù… Ù…Ù† Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†Ø§ØªØŒ Ù„Ø¯Ø¹Ù… Ø¨Ù†Ø§Ø¡ ÙˆØ¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ù†Ø³Ø¬Ø© Ø§Ù„Ø¹Ø¶Ù„ÙŠØ©.</li>
                <li><span class="font-bold text-yellow-500">${fats}</span> Ø¬Ø±Ø§Ù… Ù…Ù† Ø§Ù„Ø¯Ù‡ÙˆÙ†ØŒ ÙˆÙ‡ÙŠ Ø¶Ø±ÙˆØ±ÙŠØ© Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù‡Ø±Ù…ÙˆÙ†Ø§Øª ÙˆØ§Ù…ØªØµØ§Øµ Ø§Ù„ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª.</li>
            </ul>
        `;
        analysisText.innerHTML = analysisContent;
        analysisPanel.classList.remove('hidden');
    }
    
    // Gemini API Integration
    async function callGeminiAPI(prompt, title, loaderId) {
        const loader = document.getElementById(loaderId);
        const outputPanel = document.getElementById('ai-output');
        const outputTitle = document.getElementById('ai-output-title');
        const outputContent = document.getElementById('ai-output-content');

        if (!loader || !outputPanel || !outputTitle || !outputContent) {
            console.error("One of the AI output elements is missing.");
            return;
        }

        loader.classList.remove('hidden');
        outputPanel.classList.add('hidden');
        
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        let retryCount = 0;
        const maxRetries = 3;
        const baseDelay = 1000;

        async function fetchWithRetry() {
            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: {
                        parts: [{ text: "You are a professional nutritionist. Provide responses in a clear and well-structured format using HTML and Arabic language. Do not include any introductory or concluding sentences outside of the HTML body content. Do not use markdown headers." }]
                    },
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    throw new Error(`API response status: ${response.status}`);
                }
                
                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'ØªØ¹Ø°Ø± ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                
                outputTitle.textContent = title;
                outputContent.innerHTML = text;
                outputPanel.classList.remove('hidden');

            } catch (error) {
                if (retryCount < maxRetries) {
                    retryCount++;
                    const delay = baseDelay * Math.pow(2, retryCount);
                    await new Promise(res => setTimeout(res, delay));
                    await fetchWithRetry();
                } else {
                    outputTitle.textContent = "Ø®Ø·Ø£";
                    outputContent.textContent = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.";
                    outputPanel.classList.remove('hidden');
                }
            } finally {
                loader.classList.add('hidden');
            }
        }
        await fetchWithRetry();
    }
    
    window.generateMealPlan = async function() {
        if (myPlan.length === 0) {
            showToast("ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø®Ø·ØªÙƒ Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©.", 'error');
            return;
        }
        
        const totalCalories = document.getElementById('calories-result').textContent;
        const totalProtein = document.getElementById('protein-result').textContent;
        const totalCarbs = document.getElementById('carb-result').textContent;
        const totalFats = document.getElementById('fat-result').textContent;
        const totalCalcium = document.getElementById('calcium-result').textContent;
        const age = document.getElementById('age-input').value;
        const weight = document.getElementById('weight-input').value;
        const gender = document.getElementById('gender-select').value === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰';

        const prompt = `
            Ø£Ù†Ø´Ø¦ Ø®Ø·Ø© ÙˆØ¬Ø¨Ø§Øª Ù„ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ Ù„Ø´Ø®Øµ ÙŠØ¨Ù„Øº Ù…Ù† Ø§Ù„Ø¹Ù…Ø± ${age}ØŒ ÙˆØ²Ù†Ù‡ ${weight} ÙƒØ¬Ù…ØŒ ÙˆØ¬Ù†Ø³Ù‡ ${gender}. ÙŠØ¬Ø¨ Ø£Ù† ØªØ³ØªÙ‡Ø¯Ù Ø§Ù„Ø®Ø·Ø© Ø­ÙˆØ§Ù„ÙŠ ${totalCalories} Ø³Ø¹Ø±Ø© Ø­Ø±Ø§Ø±ÙŠØ©ØŒ Ùˆ${totalProtein} Ø¨Ø±ÙˆØªÙŠÙ†ØŒ Ùˆ${totalCarbs} ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§ØªØŒ Ùˆ${totalFats} Ø¯Ù‡ÙˆÙ†ØŒ Ùˆ${totalCalcium} ÙƒØ§Ù„Ø³ÙŠÙˆÙ….
            
            Ù‚Ù… Ø¨ØªØ¶Ù…ÙŠÙ† ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ø¥ÙØ·Ø§Ø± ÙˆØ§Ù„ØºØ¯Ø§Ø¡ ÙˆØ§Ù„Ø¹Ø´Ø§Ø¡ ÙˆØ§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ø®ÙÙŠÙØ©. 
            Ù‚Ø¯Ù… Ø§Ù„Ø®Ø·Ø© Ø¨ØªÙ†Ø³ÙŠÙ‚ HTMLØŒ Ù…Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¦Ù…Ø© ØºÙŠØ± Ù…Ø±ØªØ¨Ø© (<ul>) Ù„ÙƒÙ„ ÙˆØ¬Ø¨Ø©ØŒ ÙˆØ¹Ù†ÙˆØ§Ù† (<h3>) Ù„ÙƒÙ„ ÙˆØ¬Ø¨Ø©. Ø§Ø³ØªØ®Ø¯Ù… ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¬Ø°Ø§Ø¨Ø©.
        `;
        
        await saveSharedPlanToFirestore();

        await callGeminiAPI(prompt, 'Ø®Ø·ØªÙƒ Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©', 'plan-loader');
    }
    
    window.generateRecipes = async function() {
         if (myPlan.length === 0) {
            showToast("Ø£Ø¶Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø¥Ù„Ù‰ Ø®Ø·ØªÙƒ Ø£ÙˆÙ„Ø§Ù‹.", 'error');
            return;
        }
        
        const ingredients = myPlan.map(item => item.name).join(', ');

        const prompt = `
            Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©: ${ingredients}.
            Ù‚Ù… Ø¨ØªÙˆÙ„ÙŠØ¯ 3 ÙˆØµÙØ§Øª ØµØ­ÙŠØ© ÙˆÙ…Ø®ØªÙ„ÙØ©. Ù„ÙƒÙ„ ÙˆØµÙØ©ØŒ Ø§Ø°ÙƒØ±:
            - Ø§Ø³Ù… Ø§Ù„ÙˆØµÙØ© (<h3>)
            - Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª (<ul>)
            - Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ­Ø¶ÙŠØ± (Ø£Ø±Ù‚Ø§Ù… Ù…Ø±ØªØ¨Ø© <ol>)
            - Ù†ØµØ§Ø¦Ø­ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            
            Ù‚Ø¯Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨ØªÙ†Ø³ÙŠÙ‚ HTML Ø¬Ø°Ø§Ø¨ ÙˆÙ…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙŠØ¨.
        `;

        await callGeminiAPI(prompt, 'ÙˆØµÙØ§Øª Ù…Ù‚ØªØ±Ø­Ø©', 'recipes-loader');
    }

</script>
</body>
</html>

